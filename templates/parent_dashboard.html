<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Dashboard - School Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="/static/images/logo1.png" type="image/png">
    <script>
        (function() {
            const theme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (theme === 'dark') document.documentElement.classList.add('dark');
        })();
    </script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 transition-colors" x-data="parentDashboard()" x-init="init()">
    <!-- Top Navigation -->
    <nav class="bg-white dark:bg-gray-800 dark:bg-gray-800 shadow-lg sticky top-0 z-50 transition-colors">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-3xl text-indigo-600 dark:text-indigo-400 mr-3"></i>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 dark:text-white">Parent Portal</h1>
                        <p class="text-xs text-gray-600 dark:text-gray-400">School Management System</p>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Theme Toggle -->
                    <button @click="toggleTheme()" class="p-2 text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400" title="Toggle theme">
                        <i x-show="theme === 'light'" class="fas fa-moon text-xl"></i>
                        <i x-show="theme === 'dark'" class="fas fa-sun text-xl"></i>
                    </button>
                    <!-- Notifications -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="relative p-2 text-gray-600 hover:text-indigo-600">
                            <i class="fas fa-bell text-xl"></i>
                            <span x-show="notifications.length > 0"
                                class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
                                x-text="notifications.length"></span>
                        </button>

                        <div x-show="open" @click.away="open = false"
                            class="absolute right-0 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200"
                            x-transition>
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="font-semibold text-gray-900">Notifications</h3>
                            </div>
                            <div class="max-h-96 overflow-y-auto">
                                <template x-for="notif in notifications" :key="notif.id">
                                    <div class="p-4 border-b border-gray-100 hover:bg-gray-50">
                                        <div class="flex items-start">
                                            <i :class="notif.icon" class="text-indigo-600 mr-3 mt-1"></i>
                                            <div class="flex-1">
                                                <p class="text-sm text-gray-800 font-medium" x-text="notif.title"></p>
                                                <p class="text-xs text-gray-600 mt-1" x-text="notif.message"></p>
                                                <p class="text-xs text-gray-500 mt-1" x-text="notif.time"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <div x-show="notifications.length === 0" class="p-4 text-center text-gray-500">
                                    No new notifications
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Menu -->
                    <div class="flex items-center space-x-3">
                        <div class="text-right hidden md:block">
                            <p class="text-sm font-medium text-gray-900"
                                x-text="user.first_name + ' ' + user.last_name"></p>
                            <p class="text-xs text-gray-600">Parent</p>
                        </div>
                        <div class="bg-indigo-600 text-white rounded-full w-10 h-10 flex items-center justify-center">
                            <span x-text="user.first_name.charAt(0) + user.last_name.charAt(0)"></span>
                        </div>
                        <button @click="currentView = 'settings'"
                            class="p-2 text-gray-600 hover:text-indigo-600"
                            title="Settings">
                            <i class="fas fa-cog text-xl"></i>
                        </button>
                        <button @click="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Dashboard View -->
        <template x-if="currentView === 'dashboard'">
            <div>
                <!-- Children Selector -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium text-gray-700">Select Child:</label>
                        <select x-model="selectedChild" @change="loadChildData()"
                            class="ml-4 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <template x-for="child in children" :key="child.id">
                                <option :value="child.id" x-text="child.name + ' - ' + child.class"></option>
                            </template>
                        </select>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <!-- Attendance Rate -->
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Attendance Rate</p>
                                <p class="text-3xl font-bold mt-1" x-text="childData.attendance_rate + '%'"></p>
                                <p class="text-sm opacity-90 mt-1">This Month</p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 bg-opacity-20 rounded-full p-4">
                                <i class="fas fa-calendar-check text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Overall Grade -->
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Overall Grade</p>
                                <p class="text-3xl font-bold mt-1" x-text="childData.overall_grade"></p>
                                <p class="text-sm opacity-90 mt-1" x-text="childData.average_percentage + '%'"></p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 bg-opacity-20 rounded-full p-4">
                                <i class="fas fa-chart-line text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Pending Fees - NOW WITH REAL DATA -->
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-lg p-6 text-white cursor-pointer"
                        @click="showFeesModal = true">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Pending Fees</p>
                                <p class="text-3xl font-bold mt-1">GHS <span x-text="childData.pending_fees"></span></p>
                                <button class="text-sm opacity-90 mt-1 underline">View Details →</button>
                            </div>
                            <div class="bg-white dark:bg-gray-800 bg-opacity-20 rounded-full p-4">
                                <i class="fas fa-money-bill-wave text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Class Rank -->
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm opacity-90">Class Rank</p>
                                <p class="text-3xl font-bold mt-1" x-text="childData.class_rank"></p>
                                <p class="text-sm opacity-90 mt-1" x-text="'Out of ' + childData.total_students"></p>
                            </div>
                            <div class="bg-white dark:bg-gray-800 bg-opacity-20 rounded-full p-4">
                                <i class="fas fa-trophy text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Left Column -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Academic Performance -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900">Academic Performance</h3>
                            </div>
                            <div class="p-6">
                                <canvas id="performanceChart"></canvas>
                            </div>
                        </div>

                        <!-- Subject-wise Performance -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900">Subject Averages</h3>
                            </div>
                            <div class="p-6">
                                <ul class="space-y-4">
                                    <template x-for="subject in childData.subject_averages" :key="subject.subject">
                                        <li class="flex items-center justify-between">
                                            <span class="font-medium text-gray-700" x-text="subject.subject"></span>
                                            <span class="font-bold text-lg" :class="{
                                                    'text-green-600': subject.average >= 80,
                                                    'text-blue-600': subject.average >= 70 && subject.average < 80,
                                                    'text-yellow-600': subject.average >= 50 && subject.average < 70,
                                                    'text-red-600': subject.average < 50
                                                }" x-text="subject.average + '%'"></span>
                                        </li>
                                    </template>
                                    <template
                                        x-if="!childData.subject_averages || childData.subject_averages.length === 0">
                                        <p class="text-center text-gray-500">No subject grades available yet.</p>
                                    </template>
                                </ul>
                            </div>
                        </div>

                        <!-- Recent Results -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-900">Recent Test Results</h3>
                                <button @click="showAllResults()" class="text-indigo-600 text-sm hover:underline">View
                                    All →</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                Subject</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                Test</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                Score</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                Grade</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                Date</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200">
                                        <template x-for="result in childData.recent_results" :key="result.id">
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                                    x-text="result.subject"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                                    x-text="result.test_name"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                                                    x-text="result.score + '/' + result.total"></td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span :class="{
                                                        'bg-green-100 text-green-800': result.grade === 'A' || result.grade === 'A+',
                                                        'bg-blue-100 text-blue-800': result.grade === 'B' || result.grade === 'B+',
                                                        'bg-yellow-100 text-yellow-800': result.grade === 'C' || result.grade === 'C+',
                                                        'bg-red-100 text-red-800': result.grade === 'D' || result.grade === 'F'
                                                    }" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                        x-text="result.grade"></span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                                    x-text="result.date"></td>
                                            </tr>
                                        </template>
                                        <template x-if="childData.recent_results.length === 0">
                                            <tr>
                                                <td colspan="5" class="px-6 py-4 text-center text-gray-500">No test
                                                    results available</td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Attendance Calendar -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                            <div class="p-6 border-b border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900">Attendance This Month</h3>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-7 gap-2 text-center">
                                    <template x-for="day in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']"
                                        :key="day">
                                        <div class="text-xs font-medium text-gray-500 py-2" x-text="day"></div>
                                    </template>
                                    <template x-for="day in childData.attendance_calendar" :key="day.date">
                                        <div :class="{
                                            'bg-green-100 text-green-800': day.status === 'present',
                                            'bg-red-100 text-red-800': day.status === 'absent',
                                            'bg-yellow-100 text-yellow-800': day.status === 'late',
                                            'bg-gray-100 text-gray-400': day.status === 'holiday'
                                        }"
                                            class="aspect-square flex items-center justify-center rounded-lg text-sm font-medium">
                                            <span x-text="day.day"></span>
                                        </div>
                                    </template>
                                </div>
                                <div class="mt-4 flex justify-center space-x-6 text-sm">
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-green-500 rounded mr-2"></div>
                                        <span>Present</span>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-red-500 rounded mr-2"></div>
                                        <span>Absent</span>
                                    </div>
                                    <div class="flex items-center">
                                        <div class="w-3 h-3 bg-yellow-500 rounded mr-2"></div>
                                        <span>Late</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="space-y-6">
                        <!-- Student Info Card -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <div class="text-center">
                                <div
                                    class="bg-indigo-100 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-user text-indigo-600 text-4xl"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900" x-text="childData.name"></h3>
                                <p class="text-sm text-gray-600" x-text="childData.class"></p>
                                <p class="text-xs text-gray-500 mt-1">Student ID: <span
                                        x-text="childData.student_id"></span></p>
                            </div>

                            <div class="mt-6 space-y-3 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Roll Number:</span>
                                    <span class="font-medium" x-text="childData.roll_number"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Class Teacher:</span>
                                    <span class="font-medium" x-text="childData.class_teacher"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Blood Group:</span>
                                    <span class="font-medium" x-text="childData.blood_group"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                            <div class="space-y-3">
                                <!-- ✅ MESSAGE TEACHER - Opens Modal -->
                                <button @click="showTeacherSelectModal = true"
                                    class="w-full flex items-center p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition">
                                    <i class="fas fa-envelope text-indigo-600 mr-3"></i>
                                    <span class="text-gray-900">Message Teacher</span>
                                </button>

                                <button
                                    class="w-full flex items-center p-3 bg-green-50 rounded-lg hover:bg-green-100 transition">
                                    <i class="fas fa-file-download text-green-600 mr-3"></i>
                                    <span class="text-gray-900">Download Report Card</span>
                                </button>

                                <button @click="showFeesModal = true"
                                    class="w-full flex items-center p-3 bg-orange-50 rounded-lg hover:bg-orange-100 transition">
                                    <i class="fas fa-credit-card text-orange-600 mr-3"></i>
                                    <span class="text-gray-900">View Fees Details</span>
                                </button>

                                <button @click="downloadTimetable()"
                                    class="w-full flex items-center p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                                    <i class="fas fa-calendar text-blue-600 mr-3"></i>
                                    <span class="text-gray-900">Download Timetable</span>
                                </button>
                            </div>
                        </div>


                        <!-- Teacher Contact -->
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Teacher Contact</h3>
                            <div class="space-y-4">
                                <template x-for="teacher in childData.teachers" :key="teacher.id">
                                    <div class="flex items-center">
                                        <div
                                            class="bg-gray-200 rounded-full w-10 h-10 flex items-center justify-center mr-3">
                                            <i class="fas fa-user text-gray-600"></i>
                                        </div>
                                        <div class="flex-1">
                                            <p class="text-sm font-medium text-gray-900" x-text="teacher.name"></p>
                                            <p class="text-xs text-gray-600" x-text="teacher.subject"></p>
                                        </div>
                                        <!-- ✅ MAILTO LINK - Opens default email client -->
                                        <a :href="`mailto:${teacher.email}?subject=Regarding ${childData.name} - ${teacher.subject}&body=Dear ${teacher.name},%0D%0A%0D%0AI hope this message finds you well. I am writing regarding my child, ${childData.name} (${childData.student_id}), who is in your ${teacher.subject} class.%0D%0A%0D%0A[Please type your message here]%0D%0A%0D%0AThank you for your time and dedication.%0D%0A%0D%0ABest regards,%0D%0A${user.first_name} ${user.last_name}`"
                                            class="text-indigo-600 hover:text-indigo-800 transition" title="Send Email">
                                            <i class="fas fa-envelope text-lg"></i>
                                        </a>
                                    </div>
                                </template>
                                <template x-if="childData.teachers.length === 0">
                                    <div class="text-center text-gray-500 py-4">No teachers assigned</div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- All Results View -->
        <template x-if="currentView === 'all_results'">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">All Test Results for <span
                            x-text="selectedChildForResults.name"></span></h2>
                    <button @click="currentView = 'dashboard'" class="text-indigo-600 hover:underline">← Back to
                        Dashboard</button>
                </div>

                <div class="space-y-6">
                    <template x-for="(results, year) in allResultsData" :key="year">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800 mb-4" x-text="year"></h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                Subject</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                Test</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                Score</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                Grade</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                                Date</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200">
                                        <template x-for="result in results" :key="result.id">
                                            <tr class="hover:bg-gray-50">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                                    x-text="result.subject"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                                    x-text="result.test_name"></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                                                    x-text="result.score + '/' + result.total"></td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span :class="{
                                                        'bg-green-100 text-green-800': result.grade === 'A' || result.grade === 'A+',
                                                        'bg-blue-100 text-blue-800': result.grade === 'B' || result.grade === 'B+',
                                                        'bg-yellow-100 text-yellow-800': result.grade === 'C' || result.grade === 'C+',
                                                        'bg-red-100 text-red-800': result.grade === 'D' || result.grade === 'F'
                                                    }" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                        x-text="result.grade"></span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                                    x-text="result.date"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <!-- Settings View -->
        <template x-if="currentView === 'settings'">
            <div>
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Settings</h2>
                    <button @click="currentView = 'dashboard'" class="text-indigo-600 hover:underline">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                    </button>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Settings Menu -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
                        <nav class="space-y-1 p-4">
                            <button @click="settingsView = 'profile'"
                                :class="settingsView === 'profile' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-700 hover:bg-gray-50'"
                                class="w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg">
                                <i class="fas fa-user mr-3"></i>
                                Profile
                            </button>
                            <button @click="settingsView = 'password'"
                                :class="settingsView === 'password' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-700 hover:bg-gray-50'"
                                class="w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg">
                                <i class="fas fa-lock mr-3"></i>
                                Change Password
                            </button>
                        </nav>
                    </div>

                    <!-- Settings Content -->
                    <div class="lg:col-span-2">
                        <!-- Profile Settings -->
                        <div x-show="settingsView === 'profile'" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Profile Information</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                    <input type="text" :value="user.username" disabled
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                                        <input type="text" :value="user.first_name" disabled
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                                        <input type="text" :value="user.last_name" disabled
                                            class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" :value="user.email" disabled
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                                    <input type="text" value="Parent" disabled
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
                                </div>
                                <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p class="text-sm text-blue-700">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        Contact your administrator to update your profile information.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Password Change Settings -->
                        <div x-show="settingsView === 'password'" class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Change Password</h3>

                            <form @submit.prevent="changePassword()">
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            <i class="fas fa-lock mr-2"></i>Current Password
                                        </label>
                                        <div class="relative">
                                            <input :type="passwordForm.showCurrent ? 'text' : 'password'"
                                                x-model="passwordForm.currentPassword" required
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <button type="button" @click="passwordForm.showCurrent = !passwordForm.showCurrent"
                                                class="absolute right-3 top-2.5 text-gray-500 hover:text-gray-700">
                                                <i :class="passwordForm.showCurrent ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            <i class="fas fa-lock mr-2"></i>New Password
                                        </label>
                                        <div class="relative">
                                            <input :type="passwordForm.showNew ? 'text' : 'password'"
                                                x-model="passwordForm.newPassword" required minlength="8"
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <button type="button" @click="passwordForm.showNew = !passwordForm.showNew"
                                                class="absolute right-3 top-2.5 text-gray-500 hover:text-gray-700">
                                                <i :class="passwordForm.showNew ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                            </button>
                                        </div>
                                        <p class="text-xs text-gray-500 mt-1">Minimum 8 characters</p>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                            <i class="fas fa-lock mr-2"></i>Confirm New Password
                                        </label>
                                        <div class="relative">
                                            <input :type="passwordForm.showConfirm ? 'text' : 'password'"
                                                x-model="passwordForm.confirmPassword" required minlength="8"
                                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                            <button type="button" @click="passwordForm.showConfirm = !passwordForm.showConfirm"
                                                class="absolute right-3 top-2.5 text-gray-500 hover:text-gray-700">
                                                <i :class="passwordForm.showConfirm ? 'fas fa-eye-slash' : 'fas fa-eye'"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <div x-show="passwordForm.error" class="p-3 bg-red-50 border border-red-200 rounded-lg">
                                        <p class="text-red-700 text-sm">
                                            <i class="fas fa-exclamation-circle mr-2"></i><span x-text="passwordForm.error"></span>
                                        </p>
                                    </div>

                                    <div x-show="passwordForm.success" class="p-3 bg-green-50 border border-green-200 rounded-lg">
                                        <p class="text-green-700 text-sm">
                                            <i class="fas fa-check-circle mr-2"></i><span x-text="passwordForm.success"></span>
                                        </p>
                                    </div>

                                    <div class="flex gap-4">
                                        <button type="submit" :disabled="passwordForm.changing"
                                            class="flex-1 bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed font-medium">
                                            <span x-show="!passwordForm.changing">
                                                <i class="fas fa-check mr-2"></i>Change Password
                                            </span>
                                            <span x-show="passwordForm.changing">
                                                <i class="fas fa-spinner fa-spin mr-2"></i>Changing...
                                            </span>
                                        </button>
                                        <button type="button" @click="resetPasswordForm()"
                                            class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 text-gray-700 font-medium">
                                            <i class="fas fa-times mr-2"></i>Cancel
                                        </button>
                                    </div>
                                </div>
                            </form>

                            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <p class="text-sm text-yellow-800">
                                    <i class="fas fa-shield-alt mr-2"></i>
                                    <strong>Security Tip:</strong> Use a strong password with at least 8 characters, including letters, numbers, and special characters.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- FEES MODAL -->
    <div x-show="showFeesModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        @click.self="showFeesModal = false" x-transition>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div
                class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white p-6 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold">Fee Details</h2>
                    <p class="text-sm opacity-90" x-text="childData.name + ' - ' + childData.class"></p>
                </div>
                <button @click="showFeesModal = false"
                    class="text-white hover:bg-white dark:bg-gray-800 hover:bg-opacity-20 rounded-full p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
                <!-- Fee Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                        <p class="text-sm text-blue-600 font-medium">Total Fees</p>
                        <p class="text-2xl font-bold text-blue-900">GHS <span
                                x-text="childData.fee_summary?.total_fees || 0"></span></p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                        <p class="text-sm text-green-600 font-medium">Amount Paid</p>
                        <p class="text-2xl font-bold text-green-900">GHS <span
                                x-text="childData.fee_summary?.total_paid || 0"></span></p>
                    </div>
                    <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
                        <p class="text-sm text-orange-600 font-medium">Balance</p>
                        <p class="text-2xl font-bold text-orange-900">GHS <span
                                x-text="childData.fee_summary?.total_balance || 0"></span></p>
                    </div>
                </div>

                <!-- Fees Breakdown -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Fee Breakdown by Term</h3>
                    <template x-for="fee in childData.fees" :key="fee.id">
                        <div class="bg-white dark:bg-gray-800 border border-gray-200 rounded-lg p-4 mb-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h4 class="font-semibold text-gray-900"
                                        x-text="fee.term + ' - ' + fee.academic_year"></h4>
                                    <p class="text-sm text-gray-600">Due Date: <span x-text="fee.due_date"></span></p>
                                </div>
                                <span :class="{
                                    'bg-green-100 text-green-800': fee.status === 'paid',
                                    'bg-yellow-100 text-yellow-800': fee.status === 'partial',
                                    'bg-orange-100 text-orange-800': fee.status === 'pending',
                                    'bg-red-100 text-red-800': fee.status === 'overdue'
                                }" class="px-3 py-1 rounded-full text-xs font-semibold uppercase"
                                    x-text="fee.status"></span>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm mb-3">
                                <div>
                                    <p class="text-gray-600">Total Amount</p>
                                    <p class="font-semibold">GHS <span x-text="fee.total_amount"></span></p>
                                </div>
                                <div>
                                    <p class="text-gray-600">Discount</p>
                                    <p class="font-semibold text-green-600">- GHS <span x-text="fee.discount"></span>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-gray-600">Amount Paid</p>
                                    <p class="font-semibold text-blue-600">GHS <span x-text="fee.amount_paid"></span>
                                    </p>
                                </div>
                                <div>
                                    <p class="text-gray-600">Balance</p>
                                    <p class="font-semibold"
                                        :class="fee.balance > 0 ? 'text-red-600' : 'text-green-600'">
                                        GHS <span x-text="fee.balance"></span>
                                    </p>
                                </div>
                            </div>

                            <!-- Fee Components Breakdown -->
                            <details class="mt-3">
                                <summary
                                    class="cursor-pointer text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                                    View detailed breakdown
                                </summary>
                                <div class="mt-3 grid grid-cols-2 md:grid-cols-3 gap-2 text-xs bg-gray-50 p-3 rounded">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Tuition:</span>
                                        <span class="font-medium">GHS <span
                                                x-text="fee.breakdown.tuition"></span></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Admission:</span>
                                        <span class="font-medium">GHS <span
                                                x-text="fee.breakdown.admission"></span></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Examination:</span>
                                        <span class="font-medium">GHS <span
                                                x-text="fee.breakdown.examination"></span></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Library:</span>
                                        <span class="font-medium">GHS <span
                                                x-text="fee.breakdown.library"></span></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Sports:</span>
                                        <span class="font-medium">GHS <span x-text="fee.breakdown.sports"></span></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Laboratory:</span>
                                        <span class="font-medium">GHS <span
                                                x-text="fee.breakdown.laboratory"></span></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Uniform:</span>
                                        <span class="font-medium">GHS <span
                                                x-text="fee.breakdown.uniform"></span></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Transport:</span>
                                        <span class="font-medium">GHS <span
                                                x-text="fee.breakdown.transport"></span></span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Miscellaneous:</span>
                                        <span class="font-medium">GHS <span
                                                x-text="fee.breakdown.miscellaneous"></span></span>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </template>

                    <template x-if="childData.fees?.length === 0">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2"></i>
                            <p>No fees assigned yet</p>
                        </div>
                    </template>
                </div>

                <!-- Payment History -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Payment History</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Receipt
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Term
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Method
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                        Reference</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200">
                                <template x-for="payment in childData.payment_history" :key="payment.id">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-indigo-600"
                                            x-text="payment.receipt_number"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900"
                                            x-text="payment.payment_date"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600"
                                            x-text="payment.term"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold text-green-600">
                                            GHS <span x-text="payment.amount"></span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600"
                                            x-text="payment.payment_method"></td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500"
                                            x-text="payment.reference || '-'"></td>
                                    </tr>
                                </template>
                                <template x-if="childData.payment_history?.length === 0">
                                    <tr>
                                        <td colspan="6" class="px-4 py-8 text-center text-gray-500">
                                            No payment history available
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 flex justify-end space-x-3">
                <button @click="showFeesModal = false"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                    Close
                </button>
                <button class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                    <i class="fas fa-credit-card mr-2"></i>Make Payment
                </button>
            </div>
        </div>
    </div>
    <div x-show="showTeacherSelectModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        @click.self="showTeacherSelectModal = false" x-transition>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-2xl max-w-md w-full mx-4">
            <!-- Modal Header -->
            <div
                class="bg-gradient-to-r from-indigo-600 to-indigo-700 text-white p-6 flex justify-between items-center rounded-t-lg">
                <div>
                    <h2 class="text-xl font-bold">Select Teacher to Email</h2>
                    <p class="text-sm opacity-90">Choose a teacher to send a message</p>
                </div>
                <button @click="showTeacherSelectModal = false"
                    class="text-white hover:bg-white dark:bg-gray-800 hover:bg-opacity-20 rounded-full p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6">
                <template x-if="childData.teachers.length === 0">
                    <div class="text-center py-8">
                        <i class="fas fa-user-slash text-gray-300 text-5xl mb-4"></i>
                        <p class="text-gray-600">No teachers assigned yet</p>
                        <p class="text-sm text-gray-500 mt-2">Teachers will be assigned by the school administration</p>
                    </div>
                </template>

                <div class="space-y-3">
                    <template x-for="teacher in childData.teachers" :key="teacher.id">
                        <a :href="`mailto:${teacher.email}?subject=Regarding ${childData.name} - ${teacher.subject}&body=Dear ${teacher.name},%0D%0A%0D%0AI hope this message finds you well. I am writing regarding my child, ${childData.name} (${childData.student_id}), who is in your ${teacher.subject} class.%0D%0A%0D%0A[Please type your message here]%0D%0A%0D%0AThank you for your time and dedication.%0D%0A%0D%0ABest regards,%0D%0A${user.first_name} ${user.last_name}`"
                            @click="showTeacherSelectModal = false"
                            class="flex items-center p-4 border-2 border-gray-200 rounded-lg hover:border-indigo-500 hover:bg-indigo-50 transition cursor-pointer group">
                            <div
                                class="bg-indigo-100 rounded-full w-12 h-12 flex items-center justify-center mr-4 group-hover:bg-indigo-200">
                                <i class="fas fa-user text-indigo-600 text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-900" x-text="teacher.name"></p>
                                <p class="text-sm text-gray-600" x-text="teacher.subject"></p>
                                <p class="text-xs text-gray-500 mt-1" x-text="teacher.email"></p>
                            </div>
                            <i
                                class="fas fa-envelope text-indigo-600 text-xl group-hover:scale-110 transition-transform"></i>
                        </a>
                    </template>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="bg-gray-50 px-6 py-4 flex justify-end rounded-b-lg">
                <button @click="showTeacherSelectModal = false"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    <script>
        function parentDashboard() {
            return {
                user: {},
                parentInfo: {},
                children: [],
                selectedChild: null,
                showFeesModal: false,
                currentView: 'dashboard',
                allResultsData: {},
                selectedChildForResults: null,
                showContactModal: false,
                selectedTeacher: null,
                contactSubject: '',
                contactMessage: '',
                showTeacherSelectModal: false,
                childData: {
                    name: '',
                    class: '',
                    student_id: '',
                    roll_number: '',
                    class_teacher: '',
                    blood_group: '',
                    attendance_rate: 0,
                    overall_grade: '',
                    average_percentage: 0,
                    pending_fees: 0,
                    class_rank: 0,
                    total_students: 0,
                    recent_results: [],
                    performance_chart: { labels: [], data: [] },
                    subject_averages: [],
                    attendance_calendar: [],
                    teachers: [],
                    timetable: { periods: [], days: [] },
                    fees: [],
                    fee_summary: { total_fees: 0, total_paid: 0, total_balance: 0 },
                    payment_history: []
                },
                notifications: [],
                performanceChart: null,

                // Settings
                settingsView: 'profile', // 'profile' or 'password'
                passwordForm: {
                    currentPassword: '',
                    newPassword: '',
                    confirmPassword: '',
                    showCurrent: false,
                    showNew: false,
                    showConfirm: false,
                    changing: false,
                    error: '',
                    success: ''
                },

                // Theme
                theme: localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'),

                async init() {
                    this.applyTheme();
                    const token = localStorage.getItem('access_token');
                    const userData = localStorage.getItem('user_data');

                    if (!token || !userData) {
                        alert('Please login first');
                        window.location.href = '/auth/';
                        return;
                    }

                    this.user = JSON.parse(userData);

                    try {
                        const response = await fetch('/api/v1/dashboard/verify-parent/', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (!data.success) {
                            alert('Access Denied: Parent privileges required');
                            window.location.href = '/auth/';
                            return;
                        }

                        await this.loadParentDashboard();
                        this.loadNotifications();

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error verifying access');
                        window.location.href = '/auth/';
                    }
                },

                async loadParentDashboard() {
                    try {
                        const response = await fetch('/api/v1/parents/dashboard/', {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.parentInfo = data.data.parent_info;
                            this.children = data.data.children;

                            if (this.children.length > 0) {
                                this.selectedChild = this.children[0].id;
                                await this.loadChildData();
                            }
                        } else {
                            console.error('Error loading parent dashboard:', data.error);
                        }
                    } catch (error) {
                        console.error('Error loading parent dashboard:', error);
                    }
                },

                async loadChildData() {
                    if (!this.selectedChild) return;

                    try {
                        const response = await fetch(`/api/v1/parents/children/${this.selectedChild}/`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (data.success) {
                            const child = this.children.find(c => c.id === this.selectedChild);

                            if (child && data.data) {
                                this.childData = {
                                    name: child.name,
                                    class: child.class,
                                    student_id: child.student_id,
                                    roll_number: data.data.roll_number || 'Not Assigned',
                                    class_teacher: data.data.class_teacher || 'Not Assigned',
                                    blood_group: data.data.blood_group || 'Not Specified',
                                    attendance_rate: child.attendance_rate || 0,
                                    overall_grade: child.overall_grade || 'N/A',
                                    average_percentage: child.average_percentage || 0,
                                    pending_fees: child.pending_fees || 0,
                                    class_rank: child.class_rank || 0,
                                    total_students: child.total_students || 0,
                                    recent_results: data.data.recent_results || [],
                                    performance_chart: data.data.performance_chart || { labels: [], data: [] },
                                    subject_averages: data.data.subject_averages || [],
                                    attendance_calendar: data.data.attendance_calendar || [],
                                    teachers: data.data.teachers || [],
                                    timetable: data.data.timetable || { periods: [], days: [] },
                                    fees: data.data.fees || [],
                                    fee_summary: data.data.fee_summary || { total_fees: 0, total_paid: 0, total_balance: 0 },
                                    payment_history: data.data.payment_history || []
                                };

                                this.$nextTick(() => {
                                    this.initCharts();
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Error loading child data:', error);
                    }
                },

                async showAllResults() {
                    this.selectedChildForResults = this.children.find(c => c.id === this.selectedChild);
                    this.currentView = 'all_results';
                    try {
                        const response = await fetch(`/api/v1/parents/children/${this.selectedChild}/results/`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.allResultsData = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading all results:', error);
                    }
                },

                initCharts() {
                    const ctx = document.getElementById('performanceChart');
                    if (ctx) {
                        if (this.performanceChart) {
                            this.performanceChart.destroy();
                        }

                        this.performanceChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: this.childData.performance_chart.labels,
                                datasets: [{
                                    label: 'Average Score',
                                    data: this.childData.performance_chart.data,
                                    borderColor: '#6366f1',
                                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100
                                    }
                                }
                            }
                        });
                    }
                },

                loadNotifications() {
                    this.notifications = [];
                },

                downloadTimetable() {
                    if (!this.childData.timetable || !this.childData.timetable.periods || this.childData.timetable.periods.length === 0) {
                        alert('No timetable available for download');
                        return;
                    }

                    let timetableText = `
UNIQUE SUCCESS ACADEMY
STUDENT TIMETABLE

Student: ${this.childData.name}
Class: ${this.childData.class}
Student ID: ${this.childData.student_id}

WEEKLY SCHEDULE
================

`;

                    this.childData.timetable.periods.forEach(period => {
                        timetableText += `
${period.time}
`;
                        timetableText += `${'='.repeat(60)}
`;

                        this.childData.timetable.days.forEach(day => {
                            const dayData = period[day];
                            if (dayData && dayData.type === 'class') {
                                timetableText += `${day.toUpperCase().padEnd(12)} : ${dayData.subject.padEnd(20)} - ${dayData.teacher}
`;
                            } else if (dayData && dayData.type === 'break') {
                                timetableText += `${day.toUpperCase().padEnd(12)} : BREAK
`;
                            }
                        });
                    });

                    timetableText += `

Generated on: ${new Date().toLocaleDateString()}
`;

                    const blob = new Blob([timetableText], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Timetable_${this.childData.name.replace(/ /g, '_')}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                },

                logout() {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user_data');
                    window.location.href = '/auth/';
                },

                async changePassword() {
                    this.passwordForm.error = '';
                    this.passwordForm.success = '';

                    // Validation
                    if (this.passwordForm.newPassword !== this.passwordForm.confirmPassword) {
                        this.passwordForm.error = 'New passwords do not match';
                        return;
                    }

                    if (this.passwordForm.newPassword.length < 8) {
                        this.passwordForm.error = 'Password must be at least 8 characters long';
                        return;
                    }

                    this.passwordForm.changing = true;

                    try {
                        const response = await fetch('/api/v1/auth/change-password/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                            },
                            body: JSON.stringify({
                                current_password: this.passwordForm.currentPassword,
                                new_password: this.passwordForm.newPassword,
                                confirm_password: this.passwordForm.confirmPassword
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.passwordForm.success = 'Password changed successfully!';
                            this.passwordForm.currentPassword = '';
                            this.passwordForm.newPassword = '';
                            this.passwordForm.confirmPassword = '';

                            // Auto-hide success message after 3 seconds
                            setTimeout(() => {
                                this.passwordForm.success = '';
                            }, 3000);
                        } else {
                            this.passwordForm.error = data.error || 'Failed to change password';
                        }
                    } catch (error) {
                        console.error('Error changing password:', error);
                        this.passwordForm.error = 'Connection error. Please try again.';
                    } finally {
                        this.passwordForm.changing = false;
                    }
                },

                resetPasswordForm() {
                    this.passwordForm.currentPassword = '';
                    this.passwordForm.newPassword = '';
                    this.passwordForm.confirmPassword = '';
                    this.passwordForm.error = '';
                    this.passwordForm.success = '';
                    this.passwordForm.showCurrent = false;
                    this.passwordForm.showNew = false;
                    this.passwordForm.showConfirm = false;
                },

                toggleTheme() {
                    this.theme = this.theme === 'light' ? 'dark' : 'light';
                    this.applyTheme();
                },

                applyTheme() {
                    if (this.theme === 'dark') {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                    localStorage.setItem('theme', this.theme);
                }
            }
        }
    </script>
</body>

</html>