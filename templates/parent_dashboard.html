<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parent Dashboard - School Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100" x-data="parentDashboard()" x-init="init()">
    <!-- Top Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-3xl text-indigo-600 mr-3"></i>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Parent Portal</h1>
                        <p class="text-xs text-gray-600">School Management System</p>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Notifications -->
                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="relative p-2 text-gray-600 hover:text-indigo-600">
                            <i class="fas fa-bell text-xl"></i>
                            <span x-show="notifications.length > 0"
                                class="absolute top-0 right-0 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center"
                                x-text="notifications.length"></span>
                        </button>

                        <div x-show="open" @click.away="open = false"
                            class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200"
                            x-transition>
                            <div class="p-4 border-b border-gray-200">
                                <h3 class="font-semibold text-gray-900">Notifications</h3>
                            </div>
                            <div class="max-h-96 overflow-y-auto">
                                <template x-for="notif in notifications" :key="notif.id">
                                    <div class="p-4 border-b border-gray-100 hover:bg-gray-50">
                                        <div class="flex items-start">
                                            <i :class="notif.icon" class="text-indigo-600 mr-3 mt-1"></i>
                                            <div class="flex-1">
                                                <p class="text-sm text-gray-800 font-medium" x-text="notif.title"></p>
                                                <p class="text-xs text-gray-600 mt-1" x-text="notif.message"></p>
                                                <p class="text-xs text-gray-500 mt-1" x-text="notif.time"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <div x-show="notifications.length === 0" class="p-4 text-center text-gray-500">
                                    No new notifications
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Menu -->
                    <div class="flex items-center space-x-3">
                        <div class="text-right hidden md:block">
                            <p class="text-sm font-medium text-gray-900"
                                x-text="user.first_name + ' ' + user.last_name"></p>
                            <p class="text-xs text-gray-600">Parent</p>
                        </div>
                        <div class="bg-indigo-600 text-white rounded-full w-10 h-10 flex items-center justify-center">
                            <span x-text="user.first_name.charAt(0) + user.last_name.charAt(0)"></span>
                        </div>
                        <button @click="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Children Selector -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex items-center justify-between">
                <label class="text-sm font-medium text-gray-700">Select Child:</label>
                <select x-model="selectedChild" @change="loadChildData()"
                    class="ml-4 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <template x-for="child in children" :key="child.id">
                        <option :value="child.id" x-text="child.name + ' - ' + child.class"></option>
                    </template>
                </select>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- Attendance Rate -->
            <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Attendance Rate</p>
                        <p class="text-3xl font-bold mt-1" x-text="childData.attendance_rate + '%'"></p>
                        <p class="text-sm opacity-90 mt-1">This Month</p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-calendar-check text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Overall Grade -->
            <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Overall Grade</p>
                        <p class="text-3xl font-bold mt-1" x-text="childData.overall_grade"></p>
                        <p class="text-sm opacity-90 mt-1" x-text="childData.average_percentage + '%'"></p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-chart-line text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Pending Fees -->
            <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Pending Fees</p>
                        <p class="text-3xl font-bold mt-1">GHS <span x-text="childData.pending_fees"></span></p>
                        <button class="text-sm opacity-90 mt-1 underline">Pay Now →</button>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-money-bill-wave text-2xl"></i>
                    </div>
                </div>
            </div>

            <!-- Class Rank -->
            <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm opacity-90">Class Rank</p>
                        <p class="text-3xl font-bold mt-1" x-text="childData.class_rank"></p>
                        <p class="text-sm opacity-90 mt-1" x-text="'Out of ' + childData.total_students"></p>
                    </div>
                    <div class="bg-white bg-opacity-20 rounded-full p-4">
                        <i class="fas fa-trophy text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Academic Performance -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Academic Performance</h3>
                    </div>
                    <div class="p-6">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <!-- Recent Results -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                        <h3 class="text-lg font-semibold text-gray-900">Recent Test Results</h3>
                        <button class="text-indigo-600 text-sm hover:underline">View All →</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subject
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Test
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Score
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Grade
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="result in childData.recent_results" :key="result.id">
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                            x-text="result.subject"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                            x-text="result.test_name"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"
                                            x-text="result.score + '/' + result.total"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span :class="{
                                                'bg-green-100 text-green-800': result.grade === 'A' || result.grade === 'A+',
                                                'bg-blue-100 text-blue-800': result.grade === 'B' || result.grade === 'B+',
                                                'bg-yellow-100 text-yellow-800': result.grade === 'C' || result.grade === 'C+',
                                                'bg-red-100 text-red-800': result.grade === 'D' || result.grade === 'F'
                                            }" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                x-text="result.grade"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"
                                            x-text="result.date"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Attendance Calendar -->
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Attendance This Month</h3>
                    </div>
                    <div class="p-6">
                        <div class="grid grid-cols-7 gap-2 text-center">
                            <!-- Day headers -->
                            <template x-for="day in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']" :key="day">
                                <div class="text-xs font-medium text-gray-500 py-2" x-text="day"></div>
                            </template>
                            <!-- Calendar days -->
                            <template x-for="day in childData.attendance_calendar" :key="day.date">
                                <div :class="{
                                    'bg-green-100 text-green-800': day.status === 'present',
                                    'bg-red-100 text-red-800': day.status === 'absent',
                                    'bg-yellow-100 text-yellow-800': day.status === 'late',
                                    'bg-gray-100 text-gray-400': day.status === 'holiday'
                                }"
                                    class="aspect-square flex items-center justify-center rounded-lg text-sm font-medium">
                                    <span x-text="day.day"></span>
                                </div>
                            </template>
                        </div>
                        <div class="mt-4 flex justify-center space-x-6 text-sm">
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-green-500 rounded mr-2"></div>
                                <span>Present</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-red-500 rounded mr-2"></div>
                                <span>Absent</span>
                            </div>
                            <div class="flex items-center">
                                <div class="w-3 h-3 bg-yellow-500 rounded mr-2"></div>
                                <span>Late</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- Student Info Card -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-center">
                        <div class="bg-indigo-100 rounded-full w-24 h-24 flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-user text-indigo-600 text-4xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900" x-text="childData.name"></h3>
                        <p class="text-sm text-gray-600" x-text="childData.class"></p>
                        <p class="text-xs text-gray-500 mt-1">Student ID: <span x-text="childData.student_id"></span>
                        </p>
                    </div>

                    <div class="mt-6 space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Roll Number:</span>
                            <span class="font-medium" x-text="childData.roll_number"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Class Teacher:</span>
                            <span class="font-medium" x-text="childData.class_teacher"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Blood Group:</span>
                            <span class="font-medium" x-text="childData.blood_group"></span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <button @click="currentView = 'messages'"
                            class="w-full flex items-center p-3 bg-indigo-50 rounded-lg hover:bg-indigo-100 transition">
                            <i class="fas fa-envelope text-indigo-600 mr-3"></i>
                            <span class="text-gray-900">Message Teacher</span>
                        </button>

                        <button
                            class="w-full flex items-center p-3 bg-green-50 rounded-lg hover:bg-green-100 transition">
                            <i class="fas fa-file-download text-green-600 mr-3"></i>
                            <span class="text-gray-900">Download Report Card</span>
                        </button>

                        <button
                            class="w-full flex items-center p-3 bg-orange-50 rounded-lg hover:bg-orange-100 transition">
                            <i class="fas fa-credit-card text-orange-600 mr-3"></i>
                            <span class="text-gray-900">Pay Fees</span>
                        </button>

                        <button class="w-full flex items-center p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                            <i class="fas fa-calendar text-blue-600 mr-3"></i>
                            <span class="text-gray-900">View Timetable</span>
                        </button>
                    </div>
                </div>

                <!-- Upcoming Events -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Upcoming Events</h3>
                    <div class="space-y-4">
                        <template x-for="event in upcomingEvents" :key="event.id">
                            <div class="flex items-start p-3 bg-gray-50 rounded-lg">
                                <div class="bg-indigo-100 rounded p-2 mr-3">
                                    <i :class="event.icon" class="text-indigo-600"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900" x-text="event.title"></p>
                                    <p class="text-xs text-gray-600 mt-1" x-text="event.date"></p>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Teacher Contact -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Teacher Contact</h3>
                    <div class="space-y-4">
                        <template x-for="teacher in childData.teachers" :key="teacher.id">
                            <div class="flex items-center">
                                <div class="bg-gray-200 rounded-full w-10 h-10 flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-gray-600"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900" x-text="teacher.name"></p>
                                    <p class="text-xs text-gray-600" x-text="teacher.subject"></p>
                                </div>
                                <button class="text-indigo-600 hover:text-indigo-800">
                                    <i class="fas fa-envelope"></i>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        function parentDashboard() {
            return {
                user: {},
                parentInfo: {},
                children: [],
                selectedChild: null,
                childData: {
                    name: '',
                    class: '',
                    student_id: '',
                    roll_number: '',
                    class_teacher: '',
                    blood_group: '',
                    attendance_rate: 0,
                    overall_grade: '',
                    average_percentage: 0,
                    pending_fees: 0,
                    class_rank: 0,
                    total_students: 0,
                    recent_results: [],
                    attendance_calendar: [],
                    teachers: []
                },
                notifications: [],
                upcomingEvents: [],

                async init() {
                    const token = localStorage.getItem('access_token');
                    const userData = localStorage.getItem('user_data');

                    if (!token || !userData) {
                        alert('Please login first');
                        window.location.href = '/auth/';
                        return;
                    }

                    this.user = JSON.parse(userData);

                    // Verify parent access
                    try {
                        const response = await fetch('/api/v1/dashboard/verify-parent/', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (!data.success) {
                            alert('Access Denied: Parent privileges required');
                            window.location.href = '/auth/';
                            return;
                        }

                        await this.loadParentDashboard();
                        this.loadNotifications();
                        this.loadUpcomingEvents();

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error verifying access');
                        window.location.href = '/auth/';
                    }
                },

                async loadParentDashboard() {
                    try {
                        const response = await fetch('/api/v1/parents/dashboard/', {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.parentInfo = data.data.parent_info;
                            this.children = data.data.children;

                            if (this.children.length > 0) {
                                this.selectedChild = this.children[0].id;
                                await this.loadChildData();
                            }
                        } else {
                            console.error('Error loading parent dashboard:', data.error);
                        }
                    } catch (error) {
                        console.error('Error loading parent dashboard:', error);
                    }
                },

                async loadChildData() {
                    if (!this.selectedChild) return;

                    try {
                        const response = await fetch(`/api/v1/parents/children/${this.selectedChild}/`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (data.success) {
                            // Find the selected child from children array
                            const child = this.children.find(c => c.id === this.selectedChild);

                            if (child) {
                                this.childData = {
                                    name: child.name,
                                    class: child.class,
                                    student_id: child.student_id,
                                    roll_number: '15', // TODO: Get from API
                                    class_teacher: 'Mrs. Sarah Johnson', // TODO: Get from API
                                    blood_group: 'O+', // TODO: Get from API
                                    attendance_rate: child.attendance_rate,
                                    overall_grade: child.overall_grade,
                                    average_percentage: child.average_percentage,
                                    pending_fees: child.pending_fees,
                                    class_rank: child.class_rank,
                                    total_students: child.total_students,
                                    recent_results: [], // TODO: Get from API
                                    attendance_calendar: this.generateAttendanceCalendar(),
                                    teachers: data.data.courses.map(course => ({
                                        name: course.teacher,
                                        subject: course.subject
                                    }))
                                };

                                this.$nextTick(() => {
                                    this.initCharts();
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Error loading child data:', error);
                    }
                },

                generateAttendanceCalendar() {
                    const calendar = [];
                    const statuses = ['present', 'present', 'present', 'present', 'late', 'absent', 'holiday'];

                    for (let i = 1; i <= 30; i++) {
                        calendar.push({
                            date: `2024-09-${i.toString().padStart(2, '0')}`,
                            day: i,
                            status: statuses[Math.floor(Math.random() * statuses.length)]
                        });
                    }

                    return calendar;
                },

                initCharts() {
                    const ctx = document.getElementById('performanceChart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep'],
                                datasets: [{
                                    label: 'Average Score',
                                    data: [75, 78, 82, 80, 85, 87, 88, 86, 87],
                                    borderColor: '#6366f1',
                                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                    tension: 0.4,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        max: 100
                                    }
                                }
                            }
                        });
                    }
                },

                loadNotifications() {
                    this.notifications = [
                        {
                            id: 1,
                            icon: 'fas fa-clipboard-list',
                            title: 'New Assignment',
                            message: 'Mathematics homework due on October 5th',
                            time: '2 hours ago'
                        },
                        {
                            id: 2,
                            icon: 'fas fa-calendar',
                            title: 'Parent-Teacher Meeting',
                            message: 'Scheduled for October 10th at 3:00 PM',
                            time: '1 day ago'
                        },
                        {
                            id: 3,
                            icon: 'fas fa-money-bill',
                            title: 'Fee Reminder',
                            message: 'Term fees due by October 15th',
                            time: '2 days ago'
                        }
                    ];
                },

                loadUpcomingEvents() {
                    this.upcomingEvents = [
                        { id: 1, icon: 'fas fa-calendar-alt', title: 'Parent-Teacher Meeting', date: 'Oct 10, 2024' },
                        { id: 2, icon: 'fas fa-futbol', title: 'Sports Day', date: 'Oct 15, 2024' },
                        { id: 3, icon: 'fas fa-graduation-cap', title: 'Final Exams', date: 'Oct 25, 2024' }
                    ];
                },

                logout() {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user_data');
                    window.location.href = '/auth/';
                }
            }
        }
    </script>
</body>

</html>