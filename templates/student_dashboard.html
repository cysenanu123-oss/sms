<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Unique Success Academy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        [x-cloak] {
            display: none !important;
        }

        /* Custom Scrollbar for the modal/lists */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-gray-50 font-sans" x-data="studentDashboard()" x-init="init()">

    <nav class="bg-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-3">
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap text-3xl text-blue-600 mr-3"></i>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900 leading-tight">Unique Success Academy</h1>
                        <p class="text-xs text-gray-500 font-medium tracking-wide">STUDENT PORTAL</p>
                    </div>
                </div>

                <div class="flex items-center space-x-6">

                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open; if(open) loadNotifications()"
                            class="relative text-gray-500 hover:text-blue-600 transition">
                            <i class="fas fa-bell text-xl"></i>
                            <span x-show="unreadCount > 0"
                                class="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white"
                                x-text="unreadCount"></span>
                        </button>

                        <div x-show="open" @click.away="open = false" x-cloak
                            x-transition:enter="transition ease-out duration-100"
                            x-transition:enter-start="transform opacity-0 scale-95"
                            x-transition:enter-end="transform opacity-100 scale-100"
                            class="absolute right-0 mt-3 w-80 bg-white rounded-lg shadow-xl border border-gray-100 z-50 overflow-hidden">

                            <div class="p-3 border-b bg-gray-50 flex justify-between items-center">
                                <h3 class="font-semibold text-gray-800 text-sm">Notifications</h3>
                                <button @click="markAllRead()"
                                    class="text-xs text-blue-600 hover:text-blue-800 font-medium">Mark all read</button>
                            </div>

                            <div class="max-h-80 overflow-y-auto">
                                <template x-for="notif in notifications" :key="notif.id">
                                    <div @click="markAsRead(notif.id)"
                                        :class="notif.is_read ? 'bg-white opacity-70' : 'bg-blue-50'"
                                        class="p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition">
                                        <div class="flex items-start gap-3">
                                            <div class="mt-1"><i :class="notif.icon || 'fas fa-info-circle'"
                                                    class="text-blue-500 text-sm"></i></div>
                                            <div>
                                                <p class="text-sm font-medium text-gray-800" x-text="notif.title"></p>
                                                <p class="text-xs text-gray-600 mt-0.5" x-text="notif.message"></p>
                                                <p class="text-[10px] text-gray-400 mt-1" x-text="notif.time"></p>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                                <div x-show="notifications.length === 0" class="p-6 text-center text-gray-400">
                                    <p class="text-sm">No notifications</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="relative" x-data="{ open: false }">
                        <button @click="open = !open" class="flex items-center space-x-2 focus:outline-none">
                            <div
                                class="w-9 h-9 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold shadow-md">
                                <span x-text="(user?.first_name?.[0] || '') + (user?.last_name?.[0] || '')"></span>
                            </div>
                            <span class="hidden md:block text-sm font-medium text-gray-700"
                                x-text="user?.first_name"></span>
                            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                        </button>

                        <div x-show="open" @click.away="open = false" x-cloak x-transition
                            class="absolute right-0 mt-3 w-64 bg-white rounded-lg shadow-xl border border-gray-100 z-50">
                            <div class="p-4 border-b border-gray-100">
                                <p class="font-bold text-gray-800"
                                    x-text="(user?.first_name || '') + ' ' + (user?.last_name || '')"></p>
                                <p class="text-xs text-gray-500 truncate" x-text="user?.email"></p>
                            </div>
                            <div class="p-4 space-y-2 bg-gray-50">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Student ID</span>
                                    <span class="font-mono font-medium text-gray-700"
                                        x-text="studentInfo.student_id || '---'"></span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-500">Class</span>
                                    <span class="font-medium text-gray-700" x-text="studentInfo.class || '---'"></span>
                                </div>
                            </div>
                            <div class="p-2">
                                <button @click="logout()"
                                    class="w-full text-left px-3 py-2 text-red-600 hover:bg-red-50 rounded-md text-sm transition flex items-center">
                                    <i class="fas fa-sign-out-alt mr-2"></i> Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <div
            class="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-2xl shadow-lg p-8 text-white relative overflow-hidden">
            <div class="absolute right-0 top-0 h-full w-1/3 bg-white opacity-10 transform skew-x-12 translate-x-10">
            </div>
            <div class="relative z-10">
                <h2 class="text-3xl font-bold mb-2">Welcome back, <span x-text="user?.first_name">Student</span>! ðŸ‘‹
                </h2>
                <p class="text-blue-100 opacity-90">Here is what is happening with your academics today.</p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Courses</p>
                        <h3 class="text-2xl font-bold text-gray-800 mt-1" x-text="stats.total_courses || 0">0</h3>
                    </div>
                    <div class="p-3 bg-blue-50 rounded-lg text-blue-600">
                        <i class="fas fa-book text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Avg. Grade</p>
                        <h3 class="text-2xl font-bold text-green-600 mt-1" x-text="stats.average_grade || 'N/A'">-</h3>
                    </div>
                    <div class="p-3 bg-green-50 rounded-lg text-green-600">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Attendance</p>
                        <h3 class="text-2xl font-bold text-orange-600 mt-1" x-text="(stats.attendance_rate || 0) + '%'">
                            0%</h3>
                    </div>
                    <div class="p-3 bg-orange-50 rounded-lg text-orange-600">
                        <i class="fas fa-calendar-check text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-gray-100 hover:shadow-md transition">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Pending</p>
                        <h3 class="text-2xl font-bold text-purple-600 mt-1" x-text="stats.pending_assignments || 0">0
                        </h3>
                    </div>
                    <div class="p-3 bg-purple-50 rounded-lg text-purple-600">
                        <i class="fas fa-tasks text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <div class="lg:col-span-2 space-y-8">

                <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 class="font-bold text-gray-800 flex items-center">
                            <i class="fas fa-calendar-alt text-blue-500 mr-2"></i> Weekly Timetable
                        </h3>
                        <button @click="downloadTimetable()"
                            class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center">
                            <i class="fas fa-download mr-1"></i> Download
                        </button>
                    </div>
                    <div class="p-6 overflow-x-auto">
                        <div x-show="!timetable.periods || timetable.periods.length === 0"
                            class="text-center py-10 text-gray-400">
                            <i class="fas fa-calendar-times text-3xl mb-3 opacity-50"></i>
                            <p>No timetable available yet.</p>
                        </div>

                        <table x-show="timetable.periods && timetable.periods.length > 0" class="w-full text-sm">
                            <thead>
                                <tr class="text-left text-gray-500 border-b">
                                    <th class="pb-3 font-medium">Time</th>
                                    <template x-for="day in timetable.days" :key="day">
                                        <th class="pb-3 font-medium capitalize px-2" x-text="day"></th>
                                    </template>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="period in timetable.periods" :key="period.time">
                                    <tr class="border-b last:border-0 hover:bg-gray-50 transition">
                                        <td class="py-3 font-medium text-gray-600 whitespace-nowrap pr-4"
                                            x-text="period.time"></td>
                                        <template x-for="day in timetable.days" :key="day">
                                            <td class="py-2 px-2">
                                                <div x-show="period[day]"
                                                    :class="period[day]?.type === 'class' ? 'bg-blue-100 text-blue-800 border-l-2 border-blue-500' : 'bg-gray-100 text-gray-500 text-center italic'"
                                                    class="p-2 rounded text-xs min-h-[40px] flex flex-col justify-center">
                                                    <span class="font-semibold block"
                                                        x-text="period[day]?.subject || 'Break'"></span>
                                                    <span x-show="period[day]?.type === 'class'"
                                                        class="text-[10px] opacity-75 mt-0.5"
                                                        x-text="period[day]?.teacher"></span>
                                                </div>
                                            </td>
                                        </template>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                    <div class="p-6 border-b border-gray-100">
                        <h3 class="font-bold text-gray-800 flex items-center">
                            <i class="fas fa-book-reader text-yellow-500 mr-2"></i> Learning Resources
                        </h3>
                    </div>
                    <div class="divide-y divide-gray-100 max-h-96 overflow-y-auto">
                        <template x-for="resource in resources" :key="resource.id">
                            <a :href="resource.file_url || resource.external_link" target="_blank"
                                class="p-4 hover:bg-gray-50 cursor-pointer transition group block">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span
                                                class="text-[10px] uppercase font-bold px-2 py-0.5 rounded"
                                                :class="{
                                                    'bg-red-100 text-red-700': resource.resource_type === 'pdf',
                                                    'bg-blue-100 text-blue-700': resource.resource_type === 'video',
                                                    'bg-green-100 text-green-700': resource.resource_type === 'link',
                                                    'bg-gray-100 text-gray-700': resource.resource_type === 'document'
                                                }"
                                                x-text="resource.resource_type"></span>
                                            <h4 class="font-semibold text-gray-800 text-sm group-hover:text-blue-600 transition"
                                                x-text="resource.title"></h4>
                                        </div>
                                        <p class="text-xs text-gray-500"
                                            x-text="`Shared by: ${resource.teacher} for ${resource.subject}`"></p>
                                    </div>
                                    <i class="fas fa-external-link-alt text-gray-300 text-xs group-hover:text-blue-500 transition-all"></i>
                                </div>
                            </a>
                        </template>
                        <div x-show="!resources || resources.length === 0" class="p-6 text-center text-gray-400 text-sm">
                            No learning resources available yet.
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                    <div class="p-6 border-b border-gray-100">
                        <h3 class="font-bold text-gray-800 flex items-center">
                            <i class="fas fa-chart-bar text-green-500 mr-2"></i> Recent Results
                        </h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 text-gray-500">
                                <tr>
                                    <th class="px-6 py-3 font-medium">Subject</th>
                                    <th class="px-6 py-3 font-medium">Test Name</th>
                                    <th class="px-6 py-3 font-medium">Date</th>
                                    <th class="px-6 py-3 font-medium text-center">Score</th>
                                    <th class="px-6 py-3 font-medium text-center">Grade</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <template x-for="result in recentResults" :key="result.id">
                                    <tr class="hover:bg-gray-50 transition">
                                        <td class="px-6 py-4 font-medium text-gray-800" x-text="result.subject"></td>
                                        <td class="px-6 py-4 text-gray-600" x-text="result.test_name"></td>
                                        <td class="px-6 py-4 text-gray-500 text-xs" x-text="result.date"></td>
                                        <td class="px-6 py-4 text-center font-bold text-blue-600" x-text="result.score">
                                        </td>
                                        <td class="px-6 py-4 text-center">
                                            <span :class="{
                                                'bg-green-100 text-green-700': result.grade.startsWith('A'),
                                                'bg-blue-100 text-blue-700': result.grade.startsWith('B'),
                                                'bg-yellow-100 text-yellow-700': result.grade.startsWith('C'),
                                                'bg-red-100 text-red-700': ['D', 'F'].includes(result.grade)
                                            }" class="px-2.5 py-1 rounded text-xs font-bold"
                                                x-text="result.grade"></span>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="!recentResults || recentResults.length === 0">
                                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">No recent results found.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="space-y-8">

                <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                        <h3 class="font-bold text-gray-800 flex items-center">
                            <i class="fas fa-clipboard-list text-purple-600 mr-2"></i> Assignments
                        </h3>
                        <span class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded-full"
                            x-text="assignments.length"></span>
                    </div>

                    <div class="p-4 max-h-[500px] overflow-y-auto">
                        <div x-show="!assignments || assignments.length === 0" class="text-center py-8 text-gray-400">
                            <i class="fas fa-check-circle text-4xl mb-3 opacity-30"></i>
                            <p class="text-sm">All caught up! No pending assignments.</p>
                        </div>

                        <div class="space-y-4">
                            <template x-for="assignment in assignments" :key="assignment.id">
                                <div class="bg-white rounded-lg border p-4 transition hover:shadow-md" :class="{
                                        'border-red-200 bg-red-50': assignment.status_color === 'red',
                                        'border-yellow-200 bg-yellow-50': assignment.status_color === 'yellow',
                                        'border-blue-200 bg-blue-50': assignment.status_color === 'blue',
                                        'border-gray-200 bg-gray-50': assignment.status === 'closed'
                                     }">

                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="font-semibold text-gray-800 text-sm" x-text="assignment.title"></h4>
                                        <span class="text-[10px] px-2 py-1 rounded font-bold uppercase tracking-wider"
                                            :class="{
                                                  'bg-red-100 text-red-700': assignment.status_color === 'red',
                                                  'bg-yellow-100 text-yellow-700': assignment.status_color === 'yellow',
                                                  'bg-blue-100 text-blue-700': assignment.status_color === 'blue',
                                                  'bg-gray-200 text-gray-600': assignment.status === 'closed'
                                              }" x-text="assignment.due_status"></span>
                                    </div>

                                    <p class="text-xs text-gray-600 mb-2 line-clamp-2" x-text="assignment.description">
                                    </p>
                                    <div class="flex justify-between items-center text-xs text-gray-500 mb-3">
                                        <span x-text="assignment.subject"></span>
                                        <span>Due: <span x-text="new Date(assignment.due_date).toLocaleDateString()"
                                                class="font-medium"></span></span>
                                    </div>

                                    <div class="pt-2 border-t border-gray-200/50 flex justify-end">
                                        <input type="file" :id="'file-' + assignment.id" class="hidden"
                                            @change="handleFileUpload($event, assignment)">

                                        <template x-if="assignment.status === 'closed'">
                                            <span class="text-xs text-gray-500 flex items-center">
                                                <i class="fas fa-lock mr-1"></i> Submission Closed
                                            </span>
                                        </template>

                                        <template x-if="assignment.status === 'active'">
                                            <div class="w-full">
                                                <template x-if="!assignment.submitted">
                                                    <button
                                                        @click="document.getElementById('file-' + assignment.id).click()"
                                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-medium transition flex items-center justify-center">
                                                        <i class="fas fa-upload mr-2"></i> Upload File
                                                    </button>
                                                </template>

                                                <template x-if="assignment.submitted">
                                                    <div class="flex items-center justify-between w-full">
                                                        <span
                                                            class="text-green-600 text-xs font-bold flex items-center">
                                                            <i class="fas fa-check-circle mr-1"></i> Submitted
                                                        </span>
                                                        <template x-if="!assignment.is_past_due">
                                                            <button
                                                                @click="document.getElementById('file-' + assignment.id).click()"
                                                                class="text-yellow-600 hover:text-yellow-700 text-xs font-medium underline">
                                                                Edit
                                                            </button>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-100">
                    <div class="p-6 border-b border-gray-100">
                        <h3 class="font-bold text-gray-800 flex items-center">
                            <i class="fas fa-book-open text-indigo-600 mr-2"></i> My Courses
                        </h3>
                    </div>
                    <div class="divide-y divide-gray-100">
                        <template x-for="course in courses" :key="course.id">
                            <div @click="viewCourseDetails(course.name)"
                                class="p-4 hover:bg-gray-50 cursor-pointer transition group">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <h4 class="font-semibold text-gray-800 text-sm group-hover:text-blue-600 transition"
                                            x-text="course.name"></h4>
                                        <p class="text-xs text-gray-500 mt-1" x-text="course.teacher"></p>
                                    </div>
                                    <i
                                        class="fas fa-chevron-right text-gray-300 text-xs group-hover:text-blue-500 group-hover:translate-x-1 transition-all"></i>
                                </div>
                            </div>
                        </template>
                        <div x-show="!courses || courses.length === 0" class="p-6 text-center text-gray-500 text-sm">
                            No courses enrolled.
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div x-show="showCourseModal" x-cloak class="relative z-50" aria-labelledby="modal-title" role="dialog"
        aria-modal="true">
        <div x-show="showCourseModal" x-transition:enter="ease-out duration-300" x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100" x-transition:leave="ease-in duration-200"
            x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0"
            class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>

        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div x-show="showCourseModal" @click.away="showCourseModal = false"
                    x-transition:enter="ease-out duration-300"
                    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                    x-transition:leave="ease-in duration-200"
                    x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                    x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl">

                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="flex justify-between items-center border-b pb-3 mb-4">
                            <h3 class="text-xl font-bold leading-6 text-gray-900"
                                x-text="selectedCourse?.name || 'Course Details'"></h3>
                            <button @click="showCourseModal = false" class="text-gray-400 hover:text-gray-500">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <div class="space-y-6" x-show="selectedCourse">
                            <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                                <div>
                                    <p class="text-xs text-gray-500 uppercase">Teacher</p>
                                    <p class="font-medium text-gray-800" x-text="selectedCourse?.teacher?.name"></p>
                                    <p class="text-xs text-blue-600" x-text="selectedCourse?.teacher?.email"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 uppercase">Credits</p>
                                    <p class="font-medium text-gray-800" x-text="selectedCourse?.credits"></p>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-900 mb-2 text-sm">Weekly Schedule</h4>
                                <div class="space-y-1">
                                    <template x-for="schedule in selectedCourse?.schedule" :key="schedule.day">
                                        <div class="flex items-center text-sm">
                                            <span class="w-24 font-medium text-gray-600 capitalize"
                                                x-text="schedule.day"></span>
                                            <span class="text-gray-800 mr-2" x-text="schedule.time"></span>
                                            <span class="text-xs bg-gray-200 px-2 py-0.5 rounded text-gray-600"
                                                x-text="'Room ' + schedule.room"></span>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-semibold text-gray-900 mb-2 text-sm">Grade Distribution</h4>
                                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2 flex overflow-hidden">
                                    <div class="bg-blue-600 h-2.5"
                                        :style="'width: ' + selectedCourse?.grade_breakdown?.tests + '%'"></div>
                                    <div class="bg-green-500 h-2.5"
                                        :style="'width: ' + selectedCourse?.grade_breakdown?.assignments + '%'"></div>
                                    <div class="bg-purple-500 h-2.5"
                                        :style="'width: ' + selectedCourse?.grade_breakdown?.midterm + '%'"></div>
                                </div>
                                <div class="flex justify-between text-xs text-gray-600">
                                    <span class="flex items-center"><span
                                            class="w-2 h-2 bg-blue-600 rounded-full mr-1"></span> Tests (<span
                                            x-text="selectedCourse?.grade_breakdown?.tests"></span>%)</span>
                                    <span class="flex items-center"><span
                                            class="w-2 h-2 bg-green-500 rounded-full mr-1"></span> Assignments (<span
                                            x-text="selectedCourse?.grade_breakdown?.assignments"></span>%)</span>
                                    <span class="flex items-center"><span
                                            class="w-2 h-2 bg-purple-500 rounded-full mr-1"></span> Midterm (<span
                                            x-text="selectedCourse?.grade_breakdown?.midterm"></span>%)</span>
                                </div>
                                <div class="mt-4 pt-4 border-t flex justify-between items-center">
                                    <span class="font-bold text-gray-700">Current Overall Grade</span>
                                    <span class="text-2xl font-bold text-blue-600"
                                        x-text="selectedCourse?.grade_breakdown?.overall + '%'"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function studentDashboard() {
            return {
                user: null,
                studentInfo: {},
                courses: [],
                assignments: [],
                recentResults: [],
                timetable: { periods: [], days: [] },
                stats: {},
                notifications: [],
                unreadCount: 0,
                resources: [],

                // Modal States
                showCourseModal: false,
                selectedCourse: null,

                async init() {
                    const token = localStorage.getItem('access_token');
                    const userData = localStorage.getItem('user_data');

                    if (!token || !userData) {
                        alert('Session expired. Please login again.');
                        window.location.href = '/auth/';
                        return;
                    }

                    this.user = JSON.parse(userData);

                    try {
                        // 1. Verify Student Access
                        const verifyResponse = await fetch('/api/v1/dashboard/verify-student/', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const verifyData = await verifyResponse.json();

                        if (!verifyData.success) {
                            alert('Access Denied: Student privileges required');
                            window.location.href = '/auth/';
                            return;
                        }

                        // 2. Load Data in Parallel
                        await Promise.all([
                            this.loadStudentData(),
                            this.loadNotifications()
                        ]);

                    } catch (error) {
                        console.error('Initialization Error:', error);
                        alert('Error verifying access. Please login again.');
                        window.location.href = '/auth/';
                    }
                },

                async loadStudentData() {
                    try {
                        const response = await fetch('/api/v1/students/dashboard/', {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.studentInfo = data.data.student_info;
                            this.courses = data.data.courses;
                            this.recentResults = data.data.recent_results;
                            this.timetable = data.data.timetable;
                            this.stats = data.data.stats;
                            this.resources = data.data.resources || [];

                            // Process assignments with custom logic for display
                            this.assignments = this.processAssignments(data.data.assignments || []);
                        } else {
                            console.error('Error loading data:', data.error);
                        }
                    } catch (error) {
                        console.error('Network Error loading student data:', error);
                    }
                },

                // --- Assignment Logic ---
                processAssignments(assignments) {
                    const now = new Date();
                    return assignments.map(assignment => {
                        const dueDate = new Date(assignment.due_date);
                        const timeDiff = dueDate - now;
                        const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
                        const is_past_due = timeDiff < 0;

                        let status_color, due_status;

                        if (assignment.status === 'closed') {
                            status_color = 'gray';
                            due_status = 'Closed';
                        } else if (is_past_due) {
                            status_color = 'red';
                            due_status = 'Overdue';
                        } else if (daysDiff <= 1) {
                            status_color = 'red';
                            due_status = 'Due Today';
                        } else if (daysDiff <= 3) {
                            status_color = 'yellow';
                            due_status = `${daysDiff} days left`;
                        } else {
                            status_color = 'blue';
                            due_status = `${daysDiff} days left`;
                        }

                        return { ...assignment, is_past_due, status_color, due_status };
                    });
                },

                async handleFileUpload(event, assignment) {
                    const file = event.target.files[0];
                    if (!file) return;

                    if (file.size > 10 * 1024 * 1024) { // 10MB limit
                        alert('File size too large. Maximum 10MB allowed.');
                        event.target.value = '';
                        return;
                    }

                    // Confirmation for resubmission
                    if (assignment.submitted) {
                        if (!confirm(`Replace existing submission with "${file.name}"?`)) {
                            event.target.value = '';
                            return;
                        }
                    }

                    const formData = new FormData();
                    formData.append('assignment_id', assignment.id);
                    formData.append('file', file);

                    try {
                        const response = await fetch('/api/v1/students/assignments/submit/', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` },
                            body: formData
                        });

                        const data = await response.json();

                        if (data.success) {
                            alert('Assignment submitted successfully!');
                            await this.loadStudentData(); // Refresh list
                        } else {
                            alert('Error: ' + (data.error || 'Submission failed'));
                        }
                    } catch (error) {
                        console.error('Upload Error:', error);
                        alert('Network error during upload.');
                    } finally {
                        event.target.value = ''; // Reset input
                    }
                },

                // --- Notifications ---
                async loadNotifications() {
                    try {
                        const response = await fetch('/api/v1/dashboard/notifications/', {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                        });
                        const result = await response.json();
                        if (result.success) {
                            this.notifications = result.data.notifications;
                            this.unreadCount = result.data.unread_count;
                        }
                    } catch (error) { console.error(error); }
                },

                async markAsRead(id) {
                    try {
                        await fetch(`/api/v1/dashboard/notifications/${id}/read/`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                        });
                        await this.loadNotifications();
                    } catch (error) { console.error(error); }
                },

                async markAllRead() {
                    try {
                        await fetch('/api/v1/dashboard/notifications/mark-all-read/', {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                        });
                        await this.loadNotifications();
                    } catch (error) { console.error(error); }
                },

                // --- Utilities ---
                async viewCourseDetails(courseName) {
                    try {
                        const response = await fetch(`/api/v1/students/courses/${courseName}/`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` }
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.selectedCourse = data.data;
                            this.showCourseModal = true;
                        }
                    } catch (error) {
                        alert('Could not load course details');
                    }
                },

                downloadTimetable() {
                    if (!this.timetable.periods || this.timetable.periods.length === 0) {
                        alert('No timetable available yet');
                        return;
                    }

                    // Build the timetable text content
                    let timetableText = `
UNIQUE SUCCESS ACADEMY
STUDENT TIMETABLE
Academic Year ${this.studentInfo.academic_year || 'Current'}

Student: ${this.studentInfo.full_name || 'Student'}
Class: ${this.studentInfo.class || 'N/A'}
Student ID: ${this.studentInfo.student_id || 'N/A'}

WEEKLY SCHEDULE
================

`;

                    // Add each period
                    this.timetable.periods.forEach(period => {
                        timetableText += `\n${period.time}\n`;
                        timetableText += `-`.repeat(50) + '\n';
                        
                        this.timetable.days.forEach(day => {
                            const dayCapitalized = day.charAt(0).toUpperCase() + day.slice(1);
                            const classInfo = period[day];
                            
                            if (classInfo && classInfo.subject) {
                                if (classInfo.type === 'break') {
                                    timetableText += `${dayCapitalized.padEnd(12)}: Break\n`;
                                } else {
                                    timetableText += `${dayCapitalized.padEnd(12)}: ${classInfo.subject}`;
                                    if (classInfo.teacher) {
                                        timetableText += ` (${classInfo.teacher})`;
                                    }
                                    if (classInfo.room) {
                                        timetableText += ` - Room: ${classInfo.room}`;
                                    }
                                    timetableText += '\n';
                                }
                            } else {
                                timetableText += `${dayCapitalized.padEnd(12)}: Free Period\n`;
                            }
                        });
                        
                        timetableText += '\n';
                    });

                    timetableText += `\n\nGenerated on: ${new Date().toLocaleString()}\n`;
                    timetableText += `Unique Success Academy - Student Portal\n`;

                    // Create and download the file
                    const blob = new Blob([timetableText], { type: 'text/plain' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Timetable_${this.studentInfo.student_id || 'Student'}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                },

                logout() {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user_data');
                    window.location.href = '/auth/';
                }
            }
        }
    </script>
</body>

</html>