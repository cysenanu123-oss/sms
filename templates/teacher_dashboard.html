<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard - School Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.3/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>

<body class="bg-gray-100" x-data="teacherDashboard()" x-init="init()">
    <!-- Top Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <i class="fas fa-chalkboard-teacher text-3xl text-indigo-600 mr-3"></i>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">Teacher Dashboard</h1>
                        <p class="text-xs text-gray-600">School Management System</p>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <div class="hidden md:block text-right">
                        <p class="text-sm font-medium text-gray-900" x-text="currentDate"></p>
                        <p class="text-xs text-gray-600" x-text="currentTime"></p>
                    </div>

                    <div class="flex items-center space-x-3">
                        <div class="text-right hidden md:block">
                            <p class="text-sm font-medium text-gray-900"
                                x-text="user.first_name + ' ' + user.last_name"></p>
                            <p class="text-xs text-gray-600">Teacher</p>
                        </div>
                        <div class="bg-indigo-600 text-white rounded-full w-10 h-10 flex items-center justify-center">
                            <span
                                x-text="user.first_name ? user.first_name.charAt(0) + user.last_name.charAt(0) : 'T'"></span>
                        </div>
                        <button @click="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white shadow-lg overflow-y-auto">
            <nav class="mt-5 px-2">
                <a @click="currentView = 'overview'"
                    :class="currentView === 'overview' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                    class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg cursor-pointer mb-1">
                    <i class="fas fa-home mr-3"></i>
                    Overview
                </a>

                <a @click="currentView = 'classes'"
                    :class="currentView === 'classes' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                    class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg cursor-pointer mb-1">
                    <i class="fas fa-school mr-3"></i>
                    My Classes
                </a>

                <a @click="currentView = 'attendance'"
                    :class="currentView === 'attendance' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                    class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg cursor-pointer mb-1">
                    <i class="fas fa-calendar-check mr-3"></i>
                    Mark Attendance
                </a>

                <a @click="currentView = 'assignments'"
                    :class="currentView === 'assignments' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                    class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg cursor-pointer mb-1">
                    <i class="fas fa-tasks mr-3"></i>
                    Assignments
                </a>

                <a @click="currentView = 'resources'"
                    :class="currentView === 'resources' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                    class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg cursor-pointer mb-1">
                    <i class="fas fa-folder-open mr-3"></i>
                    Resources
                </a>

                <a @click="currentView = 'grades'"
                    :class="currentView === 'Grades' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                    class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg cursor-pointer mb-1">
                    <i class="fas fa-chart-bar mr-3"></i>
                    Grades
                </a>

                <a @click="currentView = 'reports'"
                    :class="currentView === 'reports' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                    class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg cursor-pointer mb-1">
                    <i class="fas fa-chart-bar mr-3"></i>
                    Reports
                </a>

                <a @click="currentView = 'promote'"
                    :class="currentView === 'promote' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                    class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg cursor-pointer mb-1">
                    <i class="fas fa-arrow-up mr-3"></i>
                    Promote Students
                </a>

                <a @click="currentView = 'timetable'"
                    :class="currentView === 'timetable' ? 'bg-indigo-50 text-indigo-600' : 'text-gray-600 hover:bg-gray-50'"
                    class="group flex items-center px-4 py-3 text-sm font-medium rounded-lg cursor-pointer mb-1">
                    <i class="fas fa-calendar-alt mr-3"></i>
                    My Timetable
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gray-50 p-6">
            <!-- Loading State -->
            <div x-show="loading" class="flex items-center justify-center h-64">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-4xl text-indigo-600 mb-4"></i>
                    <p class="text-gray-600">Loading dashboard...</p>
                </div>
            </div>

            <!-- Overview Section -->
            <div x-show="currentView === 'overview' && !loading">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Welcome back, <span x-text="user.first_name"></span>!
                    </h2>
                    <p class="text-gray-600">Here's what's happening in your classes today.</p>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Classes</p>
                                <p class="text-3xl font-bold text-gray-900" x-text="stats.total_classes"></p>
                            </div>
                            <div class="bg-blue-100 rounded-full p-4">
                                <i class="fas fa-school text-blue-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Students</p>
                                <p class="text-3xl font-bold text-gray-900" x-text="stats.total_students"></p>
                            </div>
                            <div class="bg-green-100 rounded-full p-4">
                                <i class="fas fa-user-graduate text-green-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Pending Assignments</p>
                                <p class="text-3xl font-bold text-gray-900" x-text="stats.pending_assignments"></p>
                            </div>
                            <div class="bg-orange-100 rounded-full p-4">
                                <i class="fas fa-clipboard-list text-orange-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Avg Attendance</p>
                                <p class="text-3xl font-bold text-gray-900" x-text="stats.avg_attendance + '%'"></p>
                            </div>
                            <div class="bg-purple-100 rounded-full p-4">
                                <i class="fas fa-calendar-check text-purple-600 text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Schedule -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Today's Schedule</h3>
                        <div x-show="todaySchedule.length === 0" class="text-center py-8 text-gray-500">
                            No classes scheduled for today
                        </div>
                        <div class="space-y-3">
                            <template x-for="period in todaySchedule" :key="period.id">
                                <div
                                    class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <div class="flex items-center">
                                        <div class="bg-indigo-100 rounded p-2 mr-3">
                                            <i class="fas fa-clock text-indigo-600"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900" x-text="period.time"></p>
                                            <p class="text-sm text-gray-600"
                                                x-text="period.class + ' - ' + period.subject"></p>
                                        </div>
                                    </div>
                                    <button @click="markAttendanceQuick(period)"
                                        class="text-indigo-600 hover:text-indigo-800 text-sm">
                                        Mark Attendance →
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <button @click="currentView = 'attendance'"
                                class="flex flex-col items-center p-4 border-2 border-indigo-200 rounded-lg hover:bg-indigo-50 transition">
                                <i class="fas fa-calendar-check text-indigo-600 text-2xl mb-2"></i>
                                <span class="text-sm font-medium">Mark Attendance</span>
                            </button>
                            <button @click="currentView = 'assignments'; showCreateAssignment = true"
                                class="flex flex-col items-center p-4 border-2 border-orange-200 rounded-lg hover:bg-orange-50 transition">
                                <i class="fas fa-tasks text-orange-600 text-2xl mb-2"></i>
                                <span class="text-sm font-medium">Create Assignment</span>
                            </button>
                            <button @click="currentView = 'resources'; showUploadResource = true"
                                class="flex flex-col items-center p-4 border-2 border-green-200 rounded-lg hover:bg-green-50 transition">
                                <i class="fas fa-upload text-green-600 text-2xl mb-2"></i>
                                <span class="text-sm font-medium">Upload Resource</span>
                            </button>
                            <button @click="currentView = 'reports'"
                                class="flex flex-col items-center p-4 border-2 border-purple-200 rounded-lg hover:bg-purple-50 transition">
                                <i class="fas fa-chart-line text-purple-600 text-2xl mb-2"></i>
                                <span class="text-sm font-medium">Download Reports</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Classes Section -->
            <div x-show="currentView === 'classes' && !loading">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">My Classes</h2>
                    <p class="text-gray-600">View and manage your assigned classes</p>
                </div>

                <div x-show="myClasses.length === 0" class="bg-white rounded-lg shadow p-12 text-center">
                    <i class="fas fa-school text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg">No classes assigned yet</p>
                    <p class="text-gray-400 text-sm mt-2">Contact administration for class assignments</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <template x-for="cls in myClasses" :key="cls.id">
                        <div class="bg-white rounded-lg shadow hover:shadow-lg transition p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="bg-indigo-100 rounded-full p-3">
                                    <i class="fas fa-school text-indigo-600 text-xl"></i>
                                </div>
                                <span class="text-2xl font-bold text-gray-900" x-text="cls.total_students"></span>
                            </div>

                            <h3 class="text-lg font-semibold text-gray-900 mb-2" x-text="cls.name"></h3>
                            <p class="text-sm text-gray-600 mb-4" x-text="cls.subject"></p>

                            <div class="space-y-2 text-sm mb-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Attendance:</span>
                                    <span class="font-medium" x-text="cls.avg_attendance + '%'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Capacity:</span>
                                    <span class="font-medium" x-text="cls.total_students + '/' + cls.capacity"></span>
                                </div>
                            </div>

                            <button @click="selectClassForAttendance(cls.id)"
                                class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                                Mark Attendance
                            </button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Mark Attendance Section -->
            <div x-show="currentView === 'attendance' && !loading">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Mark Attendance</h2>
                    <p class="text-gray-600">Record student attendance for your classes</p>
                </div>

                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Class</label>
                            <select x-model="selectedClass" @change="loadStudents()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Choose a class</option>
                                <template x-for="cls in myClasses" :key="cls.id">
                                    <option :value="cls.id" x-text="cls.name"></option>
                                </template>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                            <input type="date" x-model="attendanceDate" :max="new Date().toISOString().split('T')[0]"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Period</label>
                            <select x-model="selectedPeriod"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="1">Period 1</option>
                                <option value="2">Period 2</option>
                                <option value="3">Period 3</option>
                                <option value="4">Period 4</option>
                                <option value="5">Period 5</option>
                                <option value="6">Period 6</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-4 flex space-x-3">
                        <button @click="markAllPresent()"
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-check mr-2"></i>Mark All Present
                        </button>
                        <button @click="markAllAbsent()"
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                            <i class="fas fa-times mr-2"></i>Mark All Absent
                        </button>
                    </div>
                </div>

                <!-- Students List -->
                <div x-show="selectedClass && !loadingStudents" class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Student Attendance</h3>
                        <p class="text-sm text-gray-600">Total Students: <span x-text="students.length"></span></p>
                    </div>

                    <div x-show="students.length === 0" class="p-12 text-center text-gray-500">
                        No students enrolled in this class
                    </div>

                    <div class="p-6">
                        <div class="space-y-3">
                            <template x-for="(student, index) in students" :key="student.id">
                                <div
                                    class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <div class="flex items-center flex-1">
                                        <div
                                            class="bg-gray-200 rounded-full w-10 h-10 flex items-center justify-center mr-4">
                                            <span class="font-medium text-gray-700" x-text="index + 1"></span>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900" x-text="student.name"></p>
                                            <p class="text-sm text-gray-600">Roll No: <span
                                                    x-text="student.roll_number"></span></p>
                                        </div>
                                    </div>

                                    <div class="flex space-x-2">
                                        <button @click="student.attendance = 'present'"
                                            :class="student.attendance === 'present' ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700'"
                                            class="px-4 py-2 rounded-lg hover:opacity-80 transition">
                                            <i class="fas fa-check mr-1"></i>Present
                                        </button>
                                        <button @click="student.attendance = 'absent'"
                                            :class="student.attendance === 'absent' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700'"
                                            class="px-4 py-2 rounded-lg hover:opacity-80 transition">
                                            <i class="fas fa-times mr-1"></i>Absent
                                        </button>
                                        <button @click="student.attendance = 'late'"
                                            :class="student.attendance === 'late' ? 'bg-yellow-600 text-white' : 'bg-gray-200 text-gray-700'"
                                            class="px-4 py-2 rounded-lg hover:opacity-80 transition">
                                            <i class="fas fa-clock mr-1"></i>Late
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div x-show="students.length > 0" class="mt-6 flex justify-end space-x-3">
                            <button @click="currentView = 'overview'"
                                class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                            <button @click="saveAttendance()" :disabled="savingAttendance"
                                class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                                <i class="fas fa-save mr-2"></i>
                                <span x-text="savingAttendance ? 'Saving...' : 'Save Attendance'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <div x-show="loadingStudents" class="bg-white rounded-lg shadow p-12 text-center">
                    <i class="fas fa-spinner fa-spin text-3xl text-indigo-600"></i>
                    <p class="text-gray-600 mt-4">Loading students...</p>
                </div>
            </div>

            <!-- Assignments Section -->
            <div x-show="currentView === 'assignments' && !loading">
                <div class="mb-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Assignments</h2>
                        <p class="text-gray-600">Create and manage assignments</p>
                    </div>
                    <button @click="showCreateAssignment = true"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-plus mr-2"></i>Create Assignment
                    </button>
                </div>

                <div x-show="assignments.length === 0 && !showCreateAssignment"
                    class="bg-white rounded-lg shadow p-12 text-center">
                    <i class="fas fa-tasks text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg">No assignments yet</p>
                    <button @click="showCreateAssignment = true"
                        class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        Create Your First Assignment
                    </button>
                </div>

                <!-- Create Assignment Form -->
                <div x-show="showCreateAssignment" class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Create New Assignment</h3>
                    <form @submit.prevent="createAssignment()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                <input type="text" x-model="newAssignment.title" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="e.g., Chapter 5 Homework">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Class</label>
                                <select x-model="newAssignment.class_id" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Select class</option>
                                    <template x-for="cls in myClasses" :key="cls.id">
                                        <option :value="cls.id" x-text="cls.name"></option>
                                    </template>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subject (Optional)</label>
                                <select x-model="newAssignment.subject_id"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Select subject</option>
                                    <template x-for="subject in availableSubjects" :key="subject.id">
                                        <option :value="subject.id" x-text="subject.name"></option>
                                    </template>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                                <input type="date" x-model="newAssignment.due_date" required
                                    :min="new Date().toISOString().split('T')[0]"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Marks</label>
                                <input type="number" x-model="newAssignment.total_marks" required min="1"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="100">
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea x-model="newAssignment.description" required rows="3"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Describe the assignment..."></textarea>
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Instructions
                                    (Optional)</label>
                                <textarea x-model="newAssignment.instructions" rows="2"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Additional instructions..."></textarea>
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Attachment
                                    (Optional)</label>
                                <input type="file" @change="handleAssignmentFile($event)"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" @click="showCreateAssignment = false; resetAssignmentForm()"
                                class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                            <button type="submit" :disabled="creatingAssignment"
                                class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                                <i class="fas fa-save mr-2"></i>
                                <span x-text="creatingAssignment ? 'Creating...' : 'Create Assignment'"></span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Assignments List -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <template x-for="assignment in assignments" :key="assignment.id">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900" x-text="assignment.title"></h3>
                                    <p class="text-sm text-gray-600" x-text="assignment.class"></p>
                                </div>
                                <span :class="{
                                    'bg-green-100 text-green-800': assignment.status === 'active',
                                    'bg-gray-100 text-gray-800': assignment.status === 'closed'
                                }" class="px-3 py-1 rounded-full text-xs font-medium"
                                    x-text="assignment.status.toUpperCase()"></span>
                            </div>

                            <p class="text-sm text-gray-700 mb-4" x-text="assignment.description"></p>

                            <div class="flex items-center justify-between text-sm">
                                <div>
                                    <i class="fas fa-calendar text-gray-400 mr-2"></i>
                                    <span class="text-gray-600">Due: <span x-text="assignment.due_date"></span></span>
                                </div>
                                <div>
                                    <i class="fas fa-users text-gray-400 mr-2"></i>
                                    <span class="text-gray-600"><span x-text="assignment.submissions"></span>/<span
                                            x-text="assignment.total_students"></span></span>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Resources Section -->
            <div x-show="currentView === 'resources' && !loading">
                <div class="mb-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Teaching Resources</h2>
                        <p class="text-gray-600">Upload and manage study materials</p>
                    </div>
                    <button @click="showUploadResource = true"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        <i class="fas fa-upload mr-2"></i>Upload Resource
                    </button>
                </div>

                <!-- Upload Resource Form -->
                <div x-show="showUploadResource" class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Upload New Resource</h3>
                    <form @submit.prevent="uploadResource()">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                <input type="text" x-model="newResource.title" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="e.g., Chapter 5 Notes">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Class</label>
                                <select x-model="newResource.class_id" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Select class</option>
                                    <template x-for="cls in myClasses" :key="cls.id">
                                        <option :value="cls.id" x-text="cls.name"></option>
                                    </template>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subject (Optional)</label>
                                <select x-model="newResource.subject_id"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Select subject</option>
                                    <template x-for="subject in availableSubjects" :key="subject.id">
                                        <option :value="subject.id" x-text="subject.name"></option>
                                    </template>
                                </select>
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Resource Type</label>
                                <select x-model="newResource.resource_type"
                                    @change="newResource.file = null; newResource.link = ''" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Select type</option>
                                    <option value="pdf">PDF Document</option>
                                    <option value="video">Video File</option>
                                    <option value="link">External Link (YouTube, etc.)</option>
                                    <option value="document">Other Document</option>
                                </select>
                            </div>

                            <div x-show="newResource.resource_type && newResource.resource_type !== 'link'"
                                class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload File</label>
                                <input type="file" @change="handleResourceFile($event)" required
                                    :accept="newResource.resource_type === 'pdf' ? '.pdf' : newResource.resource_type === 'video' ? 'video/*' : '*'"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <p class="text-xs text-gray-500 mt-1">
                                    <span x-show="newResource.resource_type === 'pdf'">PDF files only</span>
                                    <span x-show="newResource.resource_type === 'video'">Video files (MP4, AVI, MOV,
                                        etc.)</span>
                                    <span x-show="newResource.resource_type === 'document'">Any document file</span>
                                </p>
                            </div>

                            <div x-show="newResource.resource_type === 'link'" class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">External Link</label>
                                <input type="url" x-model="newResource.link" required
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="https://youtube.com/watch?v=...">
                                <p class="text-xs text-gray-500 mt-1">YouTube, Google Drive, or any external link</p>
                            </div>

                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description
                                    (Optional)</label>
                                <textarea x-model="newResource.description" rows="2"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                                    placeholder="Brief description of the resource..."></textarea>
                            </div>
                        </div>

                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" @click="showUploadResource = false; resetResourceForm()"
                                class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                            <button type="submit" :disabled="uploadingResource"
                                class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                                <i class="fas fa-upload mr-2"></i>
                                <span x-text="uploadingResource ? 'Uploading...' : 'Upload Resource'"></span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Resources List -->
                <div x-show="resources.length === 0 && !showUploadResource"
                    class="bg-white rounded-lg shadow p-12 text-center">
                    <i class="fas fa-folder-open text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg">No resources uploaded yet</p>
                    <button @click="showUploadResource = true"
                        class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                        Upload Your First Resource
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <template x-for="resource in resources" :key="resource.id">
                        <div class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition">
                            <div class="flex items-center justify-between mb-4">
                                <div :class="{
                                    'bg-red-100': resource.resource_type === 'pdf',
                                    'bg-blue-100': resource.resource_type === 'video',
                                    'bg-green-100': resource.resource_type === 'link',
                                    'bg-purple-100': resource.resource_type === 'document'
                                }" class="rounded-full p-3">
                                    <i :class="{
                                        'fas fa-file-pdf text-red-600': resource.resource_type === 'pdf',
                                        'fas fa-video text-blue-600': resource.resource_type === 'video',
                                        'fas fa-link text-green-600': resource.resource_type === 'link',
                                        'fas fa-file text-purple-600': resource.resource_type === 'document'
                                    }" class="text-xl"></i>
                                </div>
                            </div>

                            <h3 class="font-semibold text-gray-900 mb-2" x-text="resource.title"></h3>
                            <p class="text-sm text-gray-600 mb-2" x-text="resource.class + ' - ' + resource.subject">
                            </p>
                            <p class="text-xs text-gray-500 mb-4" x-text="resource.description || 'No description'"></p>

                            <div class="flex space-x-2">
                                <a :href="resource.resource_type === 'link' ? resource.external_link : resource.file_url"
                                    target="_blank"
                                    class="flex-1 px-4 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 text-sm text-center">
                                    <i :class="resource.resource_type === 'link' ? 'fas fa-external-link-alt' : 'fas fa-download'"
                                        class="mr-1"></i>
                                    <span x-text="resource.resource_type === 'link' ? 'Open' : 'Download'"></span>
                                </a>
                                <button @click="deleteResource(resource.id)"
                                    class="px-4 py-2 bg-red-50 text-red-600 rounded-lg hover:bg-red-100">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Grades Section -->
            <div x-show="currentView === 'grades' && !loading">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Input Grades</h2>
                    <p class="text-gray-600">Record exam and test scores for your students</p>
                </div>

                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Class</label>
                            <select x-model="gradeInput.class_id" @change="loadStudentsForGrades()"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Choose a class</option>
                                <template x-for="cls in myClasses" :key="cls.id">
                                    <option :value="cls.id" x-text="cls.name"></option>
                                </template>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Exam Type</label>
                            <select x-model="gradeInput.exam_type"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="quiz">Quiz</option>
                                <option value="test">Class Test</option>
                                <option value="midterm">Mid-term Exam</option>
                                <option value="final">Final Exam</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
                            <select x-model="gradeInput.subject_id"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select subject</option>
                                <template
                                    x-for="subject in availableSubjects.filter(s => myClasses.find(c => c.id == gradeInput.class_id)?.subject.includes(s.name))"
                                    :key="subject.id">
                                    <option :value="subject.id" x-text="subject.name"></option>
                                </template>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Exam Name</label>
                            <input type="text" x-model="gradeInput.exam_name" placeholder="e.g., Chapter 5 Quiz"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Exam Date</label>
                            <input type="date" x-model="gradeInput.exam_date"
                                :max="new Date().toISOString().split('T')[0]"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Total Marks</label>
                            <input type="number" x-model="gradeInput.total_marks" value="100" min="1"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                </div>

                <!-- Students Grades List -->
                <div x-show="gradeInput.class_id && !loadingStudents" class="bg-white rounded-lg shadow">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-900">Enter Scores</h3>
                        <p class="text-sm text-gray-600">Total Students: <span x-text="gradesStudents.length"></span>
                        </p>
                    </div>

                    <div x-show="gradesStudents.length === 0" class="p-12 text-center text-gray-500">
                        No students enrolled in this class
                    </div>

                    <div class="p-6">
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Roll
                                            No</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Student Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Score (out of <span x-text="gradeInput.total_marks"></span>)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                                            Grade</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="student in gradesStudents" :key="student.id">
                                        <tr>
                                            <td class="px-4 py-3 text-sm" x-text="student.roll_number"></td>
                                            <td class="px-4 py-3 text-sm font-medium" x-text="student.name"></td>
                                            <td class="px-4 py-3">
                                                <input type="number" x-model="student.score"
                                                    :max="gradeInput.total_marks" min="0" step="0.5"
                                                    @input="calculateGrade(student)"
                                                    class="w-24 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500">
                                            </td>
                                            <td class="px-4 py-3">
                                                <span :class="{
                                                    'bg-green-100 text-green-800': student.grade === 'A+' || student.grade === 'A',
                                                    'bg-blue-100 text-blue-800': student.grade === 'B+' || student.grade === 'B',
                                                    'bg-yellow-100 text-yellow-800': student.grade === 'C+' || student.grade === 'C',
                                                    'bg-red-100 text-red-800': student.grade === 'D' || student.grade === 'F'
                                                }" class="px-3 py-1 rounded-full text-sm font-semibold"
                                                    x-text="student.grade || '-'"></span>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>

                        <div x-show="gradesStudents.length > 0" class="mt-6 flex justify-end space-x-3">
                            <button @click="currentView = 'overview'"
                                class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                Cancel
                            </button>
                            <button @click="saveGrades()" :disabled="savingGrades"
                                class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50">
                                <i class="fas fa-save mr-2"></i>
                                <span x-text="savingGrades ? 'Saving...' : 'Save Grades'"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Reports Section -->
            <div x-show="currentView === 'reports' && !loading">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Download Reports</h2>
                    <p class="text-gray-600">Generate attendance and performance reports</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Attendance Report -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-green-100 rounded-full p-3 mr-4">
                                <i class="fas fa-calendar-check text-green-600 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">Attendance Report</h3>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Class</label>
                                <select x-model="reportFilters.attendance.class_id"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Choose class</option>
                                    <template x-for="cls in myClasses" :key="cls.id">
                                        <option :value="cls.id" x-text="cls.name"></option>
                                    </template>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                                    <input type="date" x-model="reportFilters.attendance.start_date"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                                    <input type="date" x-model="reportFilters.attendance.end_date"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Format</label>
                                <select x-model="reportFilters.attendance.format"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="csv">CSV (Excel)</option>
                                    <option value="pdf">PDF</option>
                                </select>
                            </div>

                            <button @click="downloadAttendanceReport()" :disabled="downloadingReport"
                                class="w-full px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50">
                                <i class="fas fa-download mr-2"></i>
                                <span x-text="downloadingReport ? 'Generating...' : 'Download Report'"></span>
                            </button>
                        </div>
                    </div>

                    <!-- Performance Report -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-purple-100 rounded-full p-3 mr-4">
                                <i class="fas fa-chart-line text-purple-600 text-2xl"></i>
                            </div>
                            <h3 class="text-lg font-semibold text-gray-900">Performance Report</h3>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Class</label>
                                <select x-model="reportFilters.performance.class_id"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Choose class</option>
                                    <template x-for="cls in myClasses" :key="cls.id">
                                        <option :value="cls.id" x-text="cls.name"></option>
                                    </template>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                                <select x-model="reportFilters.performance.report_type"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="quiz">Quiz Results</option>
                                    <option value="test">Class Test</option>
                                    <option value="midterm">Mid-term Exam</option>
                                    <option value="final">Final Exam</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Format</label>
                                <select x-model="reportFilters.performance.format"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="csv">CSV (Excel)</option>
                                    <option value="pdf">PDF</option>
                                </select>
                            </div>

                            <button @click="downloadPerformanceReport()" :disabled="downloadingReport"
                                class="w-full px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50">
                                <i class="fas fa-download mr-2"></i>
                                <span x-text="downloadingReport ? 'Generating...' : 'Download Report'"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timetable Section -->
            <div x-show="currentView === 'timetable' && !loading">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">My Timetable</h2>
                    <p class="text-gray-600">Your weekly teaching schedule</p>
                </div>

                <div x-show="timetablePeriods.length === 0" class="bg-white rounded-lg shadow p-12 text-center">
                    <i class="fas fa-calendar-alt text-gray-300 text-6xl mb-4"></i>
                    <p class="text-gray-500 text-lg">No timetable available</p>
                </div>

                <div x-show="timetablePeriods.length > 0" class="bg-white rounded-lg shadow overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Monday</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tuesday</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Wednesday
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Thursday
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Friday</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="period in timetablePeriods" :key="period.time">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
                                        x-text="period.time"></td>
                                    <template x-for="day in ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']"
                                        :key="day">
                                        <td class="px-6 py-4">
                                            <div x-show="period[day]" class="bg-indigo-50 rounded p-2">
                                                <p class="text-sm font-medium text-indigo-900"
                                                    x-text="period[day]?.class"></p>
                                                <p class="text-xs text-indigo-600" x-text="period[day]?.subject"></p>
                                            </div>
                                        </td>
                                    </template>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        function teacherDashboard() {
            return {
                user: {},
                currentView: 'overview',
                currentDate: '',
                currentTime: '',
                loading: true,
                loadingStudents: false,
                savingAttendance: false,
                creatingAssignment: false,
                uploadingResource: false,
                downloadingReport: false,

                stats: {
                    total_classes: 0,
                    total_students: 0,
                    pending_assignments: 0,
                    avg_attendance: 0
                },

                myClasses: [],
                students: [],
                todaySchedule: [],
                assignments: [],
                resources: [],
                timetablePeriods: [],
                availableSubjects: [],

                selectedClass: '',
                attendanceDate: new Date().toISOString().split('T')[0],
                selectedPeriod: '1',

                showCreateAssignment: false,
                showUploadResource: false,

                newAssignment: {
                    title: '',
                    description: '',
                    class_id: '',
                    subject_id: '',
                    due_date: '',
                    total_marks: 100,
                    instructions: '',
                    file: null
                },

                newResource: {
                    title: '',
                    description: '',
                    class_id: '',
                    subject_id: '',
                    resource_type: '',
                    file: null,
                    link: ''
                },

                reportFilters: {
                    attendance: {
                        class_id: '',
                        start_date: '',
                        end_date: '',
                        format: 'csv'
                    },
                    performance: {
                        class_id: '',
                        report_type: 'midterm',
                        format: 'pdf'
                    }
                },// Grade Input State
                gradeInput: {
                    class_id: '',
                    exam_type: 'quiz',
                    subject_id: '',
                    exam_name: '',
                    exam_date: new Date().toISOString().split('T')[0],
                    total_marks: 100
                },
                gradesStudents: [],
                loadingStudents: false,
                savingGrades: false,




                async init() {
                    const token = localStorage.getItem('access_token');
                    const userData = localStorage.getItem('user_data');

                    if (!token || !userData) {
                        alert('Please login first');
                        window.location.href = '/auth/';
                        return;
                    }

                    this.user = JSON.parse(userData);

                    try {
                        const response = await fetch('/api/v1/dashboard/verify-teacher/', {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const data = await response.json();

                        if (!data.success) {
                            alert('Access Denied: Teacher privileges required');
                            window.location.href = '/auth/';
                            return;
                        }

                        this.updateDateTime();
                        setInterval(() => this.updateDateTime(), 1000);
                        await this.loadTeacherData();
                        await this.loadAvailableSubjects();

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error verifying access');
                        window.location.href = '/auth/';
                    }
                },

                updateDateTime() {
                    const now = new Date();
                    this.currentDate = now.toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    this.currentTime = now.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                async loadTeacherData() {
                    const token = localStorage.getItem('access_token');

                    try {
                        const response = await fetch('/api/v1/teachers/dashboard/', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.myClasses = result.data.my_classes;
                            this.stats = result.data.stats;
                            this.todaySchedule = result.data.today_schedule;
                        } else {
                            console.error('Error loading data:', result.error);
                        }

                        await this.loadAssignments();
                        await this.loadResources();
                        await this.loadTimetable();

                    } catch (error) {
                        console.error('Error:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                async loadAvailableSubjects() {
                    const token = localStorage.getItem('access_token');

                    try {
                        const response = await fetch('/api/v1/teachers/subjects/', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();
                        if (result.success) {
                            this.availableSubjects = result.data;
                        }
                    } catch (error) {
                        console.error('Error loading subjects:', error);
                    }
                },

                async loadStudents() {
                    if (!this.selectedClass) return;

                    this.loadingStudents = true;
                    const token = localStorage.getItem('access_token');

                    try {
                        const response = await fetch(`/api/v1/teachers/class/${this.selectedClass}/students/`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.students = result.data.students;
                        } else {
                            alert('Error loading students: ' + result.error);
                        }

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error loading students');
                    } finally {
                        this.loadingStudents = false;
                    }
                },

                async loadAssignments() {
                    const token = localStorage.getItem('access_token');

                    try {
                        const response = await fetch('/api/v1/teachers/assignments/', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.assignments = result.data;
                        }

                    } catch (error) {
                        console.error('Error loading assignments:', error);
                    }
                },

                async loadResources() {
                    const token = localStorage.getItem('access_token');

                    try {
                        const response = await fetch('/api/v1/teachers/resources/', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.resources = result.data;
                        }

                    } catch (error) {
                        console.error('Error loading resources:', error);
                    }
                },

                async loadTimetable() {
                    const token = localStorage.getItem('access_token');

                    try {
                        const response = await fetch('/api/v1/teachers/timetable/', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();

                        if (result.success) {
                            this.timetablePeriods = result.data;
                        }

                    } catch (error) {
                        console.error('Error loading timetable:', error);
                    }
                },

                markAllPresent() {
                    this.students.forEach(student => student.attendance = 'present');
                },

                markAllAbsent() {
                    this.students.forEach(student => student.attendance = 'absent');
                },

                async saveAttendance() {
                    const unmarked = this.students.filter(s => !s.attendance);
                    if (unmarked.length > 0) {
                        if (!confirm(`${unmarked.length} students not marked. Continue?`)) {
                            return;
                        }
                    }

                    this.savingAttendance = true;
                    const token = localStorage.getItem('access_token');

                    const attendanceRecords = this.students.map(student => ({
                        student_id: student.id,
                        status: student.attendance || 'absent'
                    }));

                    try {
                        const response = await fetch('/api/v1/teachers/attendance/save/', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                class_id: this.selectedClass,
                                date: this.attendanceDate,
                                period: this.selectedPeriod,
                                attendance_records: attendanceRecords
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert('Attendance saved successfully!');
                            this.currentView = 'overview';
                            this.selectedClass = '';
                            this.students = [];
                        } else {
                            alert('Error saving attendance: ' + result.error);
                        }

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error saving attendance');
                    } finally {
                        this.savingAttendance = false;
                    }
                },
                async loadTimetable() {
                    const token = localStorage.getItem('access_token');

                    try {
                        const response = await fetch('/api/v1/teachers/timetable/', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();

                        if (result.success) {
                            const data = result.data;
                            
                            // Convert weekly timetable to periods format
                            const timeSlots = new Set();
                            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                            
                            // Collect all unique time slots
                            days.forEach(day => {
                                if (data.weekly_timetable[day]) {
                                    data.weekly_timetable[day].forEach(entry => {
                                        timeSlots.add(`${entry.start_time}-${entry.end_time}`);
                                    });
                                }
                            });
                            
                            // Create timetable periods
                            this.timetablePeriods = Array.from(timeSlots).sort().map(timeSlot => {
                                const period = {
                                    time: timeSlot
                                };
                                
                                days.forEach(day => {
                                    const dayEntries = data.weekly_timetable[day] || [];
                                    const entry = dayEntries.find(e => 
                                        `${e.start_time}-${e.end_time}` === timeSlot
                                    );
                                    
                                    if (entry) {
                                        period[day.toLowerCase()] = {
                                            class: entry.class,
                                            subject: entry.subject,
                                            room: entry.room
                                        };
                                    }
                                });
                                
                                return period;
                            });
                            
                            console.log('✅ Timetable loaded:', this.timetablePeriods.length, 'periods');
                        } else {
                            console.error('❌ Error loading timetable:', result.error);
                        }

                    } catch (error) {
                        console.error('❌ Error loading timetable:', error);
                    }
                },

                async createAssignment() {
                    if (!this.newAssignment.title || !this.newAssignment.class_id || !this.newAssignment.due_date) {
                        alert('Please fill in all required fields');
                        return;
                    }

                    this.creatingAssignment = true;
                    const token = localStorage.getItem('access_token');

                    const formData = new FormData();
                    formData.append('title', this.newAssignment.title);
                    formData.append('description', this.newAssignment.description);
                    formData.append('class_id', this.newAssignment.class_id);
                    if (this.newAssignment.subject_id) formData.append('subject_id', this.newAssignment.subject_id);
                    formData.append('due_date', this.newAssignment.due_date);
                    formData.append('total_marks', this.newAssignment.total_marks);
                    if (this.newAssignment.instructions) formData.append('instructions', this.newAssignment.instructions);
                    if (this.newAssignment.file) formData.append('attachment', this.newAssignment.file);

                    try {
                        const response = await fetch('/api/v1/teachers/assignment/create/', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert('Assignment created successfully!');
                            this.showCreateAssignment = false;
                            this.resetAssignmentForm();
                            await this.loadAssignments();
                        } else {
                            alert('Error creating assignment: ' + result.error);
                        }

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error creating assignment');
                    } finally {
                        this.creatingAssignment = false;
                    }
                },

                async uploadResource() {
                    if (!this.newResource.title || !this.newResource.class_id || !this.newResource.resource_type) {
                        alert('Please fill in all required fields');
                        return;
                    }

                    if (this.newResource.resource_type !== 'link' && !this.newResource.file) {
                        alert('Please select a file to upload');
                        return;
                    }

                    if (this.newResource.resource_type === 'link' && !this.newResource.link) {
                        alert('Please provide a link');
                        return;
                    }

                    this.uploadingResource = true;
                    const token = localStorage.getItem('access_token');

                    const formData = new FormData();
                    formData.append('title', this.newResource.title);
                    if (this.newResource.description) formData.append('description', this.newResource.description);
                    formData.append('class_id', this.newResource.class_id);
                    if (this.newResource.subject_id) formData.append('subject_id', this.newResource.subject_id);
                    formData.append('resource_type', this.newResource.resource_type);

                    if (this.newResource.resource_type === 'link') {
                        formData.append('link', this.newResource.link);
                    } else {
                        formData.append('file', this.newResource.file);
                    }

                    try {
                        const response = await fetch('/api/v1/teachers/resource/upload/', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            },
                            body: formData
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert('Resource uploaded successfully!');
                            this.showUploadResource = false;
                            this.resetResourceForm();
                            await this.loadResources();
                        } else {
                            alert('Error uploading resource: ' + result.error);
                        }

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error uploading resource');
                    } finally {
                        this.uploadingResource = false;
                    }
                },

                async downloadAttendanceReport() {
                    const filters = this.reportFilters.attendance;

                    if (!filters.class_id || !filters.start_date || !filters.end_date) {
                        alert('Please fill in all fields');
                        return;
                    }

                    this.downloadingReport = true;
                    const token = localStorage.getItem('access_token');

                    try {
                        const params = new URLSearchParams({
                            class_id: filters.class_id,
                            start_date: filters.start_date,
                            end_date: filters.end_date,
                            format: filters.format
                        });

                        const response = await fetch(`/api/v1/teachers/reports/attendance/?${params}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `attendance_report_${filters.start_date}_${filters.end_date}.${filters.format}`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            alert('Report downloaded successfully!');
                        } else {
                            const result = await response.json();
                            alert('Error generating report: ' + result.error);
                        }

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error downloading report');
                    } finally {
                        this.downloadingReport = false;
                    }
                },
                // Grade Input State
                gradeInput: {
                    class_id: '',
                    exam_type: 'quiz',
                    subject_id: '',
                    exam_name: '',
                    exam_date: new Date().toISOString().split('T')[0],
                    total_marks: 100
                },
                gradesStudents: [],
                loadingStudents: false,
                savingGrades: false,

                // Load students for grade entry
                async loadStudentsForGrades() {
                    if (!this.gradeInput.class_id) {
                        this.gradesStudents = [];
                        return;
                    }

                    this.loadingStudents = true;
                    try {
                        const response = await fetch(`/api/v1/teachers/class/${this.gradeInput.class_id}/students/`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                            }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                // Initialize each student with empty score and grade
                                this.gradesStudents = result.data.students.map(student => ({
                                    ...student,
                                    score: '',
                                    grade: ''
                                }));
                            }
                        } else {
                            this.showNotification('Failed to load students', 'error');
                        }
                    } catch (error) {
                        console.error('Error loading students:', error);
                        this.showNotification('Error loading students', 'error');
                    } finally {
                        this.loadingStudents = false;
                    }
                },

                // Calculate grade based on percentage
                calculateGrade(student) {
                    if (!student.score || !this.gradeInput.total_marks) {
                        student.grade = '';
                        return;
                    }

                    const percentage = (parseFloat(student.score) / parseFloat(this.gradeInput.total_marks)) * 100;

                    if (percentage >= 90) student.grade = 'A+';
                    else if (percentage >= 80) student.grade = 'A';
                    else if (percentage >= 75) student.grade = 'B+';
                    else if (percentage >= 70) student.grade = 'B';
                    else if (percentage >= 65) student.grade = 'C+';
                    else if (percentage >= 60) student.grade = 'C';
                    else if (percentage >= 50) student.grade = 'D';
                    else student.grade = 'F';
                },

                // Save all grades
                async saveGrades() {
                    // Validation
                    if (!this.gradeInput.class_id || !this.gradeInput.subject_id) {
                        this.showNotification('Please select class and subject', 'error');
                        return;
                    }

                    if (!this.gradeInput.exam_name || !this.gradeInput.exam_date) {
                        this.showNotification('Please enter exam name and date', 'error');
                        return;
                    }

                    // Check if at least one student has a score
                    const hasScores = this.gradesStudents.some(s => s.score !== '' && s.score !== null);
                    if (!hasScores) {
                        this.showNotification('Please enter at least one score', 'error');
                        return;
                    }

                    // Prepare grades data
                    const gradesData = this.gradesStudents
                        .filter(student => student.score !== '' && student.score !== null)
                        .map(student => ({
                            student_id: student.id,
                            score: parseFloat(student.score),
                            grade: student.grade
                        }));

                    const payload = {
                        class_id: parseInt(this.gradeInput.class_id),
                        subject_id: parseInt(this.gradeInput.subject_id),
                        exam_type: this.gradeInput.exam_type,
                        exam_name: this.gradeInput.exam_name,
                        exam_date: this.gradeInput.exam_date,
                        total_marks: parseFloat(this.gradeInput.total_marks),
                        grades: gradesData
                    };

                    this.savingGrades = true;
                    try {
                        const response = await fetch('/api/v1/teachers/grades/save/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                            },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            this.showNotification('Grades saved successfully!', 'success');

                            // Reset form
                            this.gradeInput = {
                                class_id: '',
                                exam_type: 'quiz',
                                subject_id: '',
                                exam_name: '',
                                exam_date: new Date().toISOString().split('T')[0],
                                total_marks: 100
                            };
                            this.gradesStudents = [];

                            // Return to overview
                            this.currentView = 'overview';
                        } else {
                            const errorData = await response.json();
                            this.showNotification(errorData.message || 'Failed to save grades', 'error');
                        }
                    } catch (error) {
                        console.error('Error saving grades:', error);
                        this.showNotification('Error saving grades', 'error');
                    } finally {
                        this.savingGrades = false;
                    }
                },

                // Helper function for notifications (if not already present)
                showNotification(message, type = 'info') {
                    // Simple notification - you can enhance this
                    alert(message);

                    // Or if you have a notification system:
                    // this.notification = { message, type, show: true };
                    // setTimeout(() => this.notification.show = false, 3000);
                },
                // In adminDashboard() function:

                async loadTimeSlots() {
                    try {
                        const response = await fetch('/api/v1/dashboard/admin/timetable/time-slots/', {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                            }
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.timeSlots = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading time slots:', error);
                    }
                },

                async loadClassTimetable() {
                    if (!this.selectedTimetableClass) return;

                    try {
                        const response = await fetch(`/api/v1/dashboard/admin/timetable/class/${this.selectedTimetableClass}/`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                            }
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.classTimetable = data.data;
                        }
                    } catch (error) {
                        console.error('Error loading class timetable:', error);
                    }
                },

                async createTimetable() {
                    if (!this.newTimetable.class_id) {
                        alert('Please select a class');
                        return;
                    }

                    this.savingTimetable = true;

                    try {
                        const response = await fetch('/api/v1/dashboard/admin/timetable/create/', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.newTimetable)
                        });

                        const data = await response.json();

                        if (data.success) {
                            alert('Timetable created successfully!');
                            this.showCreateTimetable = false;
                            this.selectedTimetableClass = data.data.class_id;
                            await this.loadClassTimetable();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    } catch (error) {
                        console.error('Error creating timetable:', error);
                        alert('Error creating timetable');
                    } finally {
                        this.savingTimetable = false;
                    }
                },

                async saveTimetableEntry() {
                    if (!this.timetableEntry.time_slot_id || !this.timetableEntry.day_of_week ||
                        !this.timetableEntry.subject_id || !this.timetableEntry.teacher_id) {
                        alert('Please fill in all required fields');
                        return;
                    }

                    this.savingTimetable = true;

                    try {
                        const response = await fetch('/api/v1/dashboard/admin/timetable/entry/create/', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                ...this.timetableEntry,
                                class_id: this.selectedTimetableClass
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            alert('Timetable entry saved successfully!');
                            this.showTimetableEntryModal = false;
                            await this.loadClassTimetable();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    } catch (error) {
                        console.error('Error saving timetable entry:', error);
                        alert('Error saving timetable entry');
                    } finally {
                        this.savingTimetable = false;
                    }
                },

                async downloadPerformanceReport() {
                    const filters = this.reportFilters.performance;

                    if (!filters.class_id) {
                        alert('Please select a class');
                        return;
                    }

                    this.downloadingReport = true;
                    const token = localStorage.getItem('access_token');

                    try {
                        const params = new URLSearchParams({
                            class_id: filters.class_id,
                            report_type: filters.report_type,
                            format: filters.format
                        });

                        const response = await fetch(`/api/v1/teachers/reports/performance/?${params}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `performance_report_${filters.report_type}.${filters.format}`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                            alert('Report downloaded successfully!');
                        } else {
                            const result = await response.json();
                            alert('Error generating report: ' + result.error);
                        }

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error downloading report');
                    } finally {
                        this.downloadingReport = false;
                    }
                },

                handleAssignmentFile(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.newAssignment.file = file;
                    }
                },

                handleResourceFile(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.newResource.file = file;
                    }
                },

                resetAssignmentForm() {
                    this.newAssignment = {
                        title: '',
                        description: '',
                        class_id: '',
                        subject_id: '',
                        due_date: '',
                        total_marks: 100,
                        instructions: '',
                        file: null
                    };
                },

                resetResourceForm() {
                    this.newResource = {
                        title: '',
                        description: '',
                        class_id: '',
                        subject_id: '',
                        resource_type: '',
                        file: null,
                        link: ''
                    };
                },

                async deleteResource(resourceId) {
                    if (!confirm('Are you sure you want to delete this resource?')) {
                        return;
                    }

                    const token = localStorage.getItem('access_token');

                    try {
                        const response = await fetch(`/api/v1/teachers/resource/${resourceId}/delete/`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        const result = await response.json();

                        if (result.success) {
                            alert('Resource deleted successfully!');
                            await this.loadResources();
                        } else {
                            alert('Error deleting resource: ' + result.error);
                        }

                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error deleting resource');
                    }
                },

                markAttendanceQuick(period) {
                    const classObj = this.myClasses.find(c => c.name === period.class);
                    if (classObj) {
                        this.selectedClass = classObj.id;
                        this.currentView = 'attendance';
                        this.loadStudents();
                    }
                },

                selectClassForAttendance(classId) {
                    this.selectedClass = classId;
                    this.currentView = 'attendance';
                    this.loadStudents();
                },

                logout() {
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    localStorage.removeItem('user_data');
                    window.location.href = '/auth/';
                }
            }
        }
    </script>
</body>

</html>